function askPassword(e){document.getElementById("passwordModalDialog").style.display="block";var t=document.getElementById("password-status");e?(t.style.display="block",t.innerHTML=e):t.style.display="none"}function checkAndLoadPrevisTag(e,t,s,a=!0){var o=new XMLHttpRequest,n="tag="+e;t&&(n+="&password="+t),o.open("POST","/rest/info",!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){var t=JSON.parse(o.responseText);if("error"===t.status)if("101"===t.code||"102"===t.code){if("102"===t.code?askPassword("Error: incorrect password"):askPassword(),a)document.getElementById("password-button").addEventListener("click",function(){document.getElementById("passwordModalDialog").style.display="none";var t=document.getElementById("password").value;""===t?askPassword():checkAndLoadPrevisTag(e,t,s,!1)})}else alert("Cannot get tag info");else t.dir||(t.dir=t.tag),s(t)}},o.send(n)}var socket=io(),url=new URL(window.location.href),gTag=url.searchParams.get("tag"),gDir=null,gHasThumbnail=!1;if(console.log(window.location),console.log("Tag:"+gTag),null===gTag||void 0===gTag)throw alert("Tag is not specified or invalid"),new Error("Tag is not specified or invalid!");var gPreset=url.searchParams.get("preset");null!==gPreset&&void 0!==gPreset||(gPreset="default");var gGui=null,hPreset=null,presetList=["default"],cameraControlList=["Orbit control","Fly control"];function showMessage(e,t=!1){document.getElementById("status-icon").style.display=t?"inline":"none",document.getElementById("status-message").innerHTML=e,console.log(e)}function getCenter(e){return{x:(e.min.x+e.max.x)/2,y:(e.min.y+e.max.y)/2,z:(e.min.z+e.max.z)/2}}function updateDatDropdown(e,t){let s="";if("Array"==t.constructor.name)for(var a=0;a<t.length;a++){s+="<option value='"+t[a]+"'>"+t[a]+"</option>"}if("Object"==t.constructor.name)for(var o in t){s+="<option value='"+t[o]+"'>"+o+"</option>"}""!=s&&(e.domElement.children[0].innerHTML=s)}function resizeImage(e,t){var s=new Image;s.src=e,s.onload=function(){var e=s.height,a=s.width;a>e?a>512&&(e*=512/a,a=512):e>512&&(a*=512/e,e=512);var o=document.createElement("canvas");o.width=a,o.height=e,o.getContext("2d").drawImage(s,0,0,a,e),t(o.toDataURL())}}var PrevisMeshRenderer=function(){var e=THREE.LoaderSupport.Validator;function t(e){this.renderer=null,this.canvas=e,this.aspectRatio=1,this.recalcAspectRatio(),this.loaded=!1,this.scene=null,this.cameraDefaults={posCamera:new THREE.Vector3(0,1,5),posCameraTarget:new THREE.Vector3(0,0,0),near:.1,far:1e4,fov:45},this.camera=null,this.cameraTarget=this.cameraDefaults.posCameraTarget,this.clock=new THREE.Clock,this.controls=null,this.allGroups=new THREE.Group,this.bbox=null,this.defaultBgColour=[64,64,72],this.jsonOri=null,this.json=null,this.groups=[],this.numberOfModels,this.modelCount=0,this.axis=null,this.maxModelSize=1}return t.prototype.initGL=function(){this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0,autoClear:!0}),this.renderer.setClearColor(this.defaultBgColour),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(this.cameraDefaults.fov,this.aspectRatio,this.cameraDefaults.near,this.cameraDefaults.far),this.resetCamera(),this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement);var e=new THREE.AmbientLight(16777215),t=new THREE.DirectionalLight(16777215),s=new THREE.DirectionalLight(16777215);t.position.set(-100,-50,100),s.position.set(100,50,-100),this.scene.add(t),this.scene.add(s),this.scene.add(e),this.scene.add(this.allGroups)},t.prototype.loadJsonConfig=function(e,t){showMessage("Load json configuration from server...",!0);var s=this,a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText);s.jsonOri=Object.assign({},e),s.json=Object.assign({},e);var a={};a.translate=void 0!==e.views.translate?e.views.translate:[0,0,0],a.showAxis=void 0===e.views.showAxis||e.views.showAxis,a.camera=void 0!==e.views.camera?e.views.camera:null,a.backgroundColour=void 0!==e.views.backgroundColour?e.views.backgroundColour:s.defaultBgColour,s.json.views=a,(e=e.objects).sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0});for(var o=0;o<e.length;o++)e[o].renderOrder||(e[o].renderOrder=0);s.json.objects=e,console.log("loadScene",s.json),showMessage(""),t()}};let o="mesh.json";e&&"default"!==e&&(o="mesh_"+e+".json"),a.open("GET","data/tags/"+gDir+"/mesh_result/"+o),a.send()},t.prototype._reportProgress=function(t){var s=e.verifyInput(t.detail.text,"");console.log("Progress: "+s),showMessage(s,!0)},t.prototype._updateBBox=function(e){this.bbox?(this.bbox.min.x=Math.min(this.bbox.min.x,e.min.x),this.bbox.min.y=Math.min(this.bbox.min.y,e.min.y),this.bbox.min.z=Math.min(this.bbox.min.z,e.min.z),this.bbox.max.x=Math.max(this.bbox.max.x,e.max.x),this.bbox.max.y=Math.max(this.bbox.max.y,e.max.y),this.bbox.max.z=Math.max(this.bbox.max.z,e.max.z)):this.bbox=e.clone()},t.prototype._loadMeshObject=function(e,t,s,a){var o=this,n="data/tags/"+gDir+"/mesh_result/"+s+"/",r=new THREE.OBJLoader2;showMessage("Loading model "+a,!0);var i=function(t){o.modelCount+=1;var s=t.detail.loaderRootNode;s.traverse(function(e){if(void 0!==e.geometry){var t=new THREE.Geometry;t.fromBufferGeometry(e.geometry),t.mergeVertices(),t.computeVertexNormals(),e.geometry.fromGeometry(t)}}),e.add(s),o._updateBBox((new THREE.Box3).setFromObject(s)),o.modelCount<o.numberOfModels?showMessage("Loading complete: "+t.detail.modelName+" ( "+o.modelCount+"/"+o.numberOfModels+")",!0):(console.log(s),o.finaliseScene(),showMessage(""))};if(r.setModelName(a),r.setLogging(!1,!1),t.hasmtl){r.loadMtl(n+t.mtl,null,function(e){r.setMaterials(e),r.load(n+t.obj,i,null,null,null,!1)})}else{var l=new THREE.MeshBasicMaterial({color:16777215});r.setMaterials(l),r.load(n+t.obj,i,null,null,null,!1)}},t.prototype._loadGroup=function(e){const t=this.json.objects[e].objects;for(var s=new THREE.Group,a=0;a<t.length;a++){var o=this.json.objects[e].name+"_"+a;this._loadMeshObject(s,t[a],this.json.objects[e].name,o)}this.allGroups.add(s),this.groups.push(s)},t.prototype.initContent=function(e,t){var s=this;s.loadJsonConfig(e,function(){s.numberOfModels=0;for(var e=0;e<s.json.objects.length;e++)s.numberOfModels+=s.json.objects[e].objects.length;s.modelCount=0;for(e=0;e<s.json.objects.length;e++)s._loadGroup(e);t()})},t.prototype.finaliseScene=function(){console.log("finaliseScene",this.bbox);var e=Math.max(Math.abs(this.bbox.max.x-this.bbox.min.x),Math.abs(this.bbox.max.y-this.bbox.min.y));e=Math.max(e,Math.abs(this.bbox.max.z-this.bbox.min.z)),this.maxModelSize=e,console.log(e),this.axis=new THREE.AxesHelper(e),this.scene.add(this.axis),this.updateAll(),this.loaded=!0},t.prototype._updateMaterial=function(e,t,s){var a=[];e.traverse(function(e){e instanceof THREE.Mesh&&a.push(e)});for(var o=0;o<a.length;o++){var n=a[o];if(Array.isArray(n.material))for(var r=0;r<n.material.length;r++)s.hasmtl||n.material[r].color.setRGB(t.colour[0]/255,t.colour[1]/255,t.colour[2]/255),n.material[r].opacity=t.alpha,n.material[r].transparent=t.alpha<1,n.material[r].side=THREE.DoubleSide;else s.hasmtl||n.material.color.setRGB(t.colour[0]/255,t.colour[1]/255,t.colour[2]/255),n.material.opacity=t.alpha,n.material.transparent=t.alpha<1,n.material.side=THREE.DoubleSide}},t.prototype.updateScene=function(){const e=this.json.objects;for(var t=0;t<e.length;t++){var s=this.groups[t];const n=e[t];for(var a=0;a<s.children.length;a++){var o=s.children[a];const r=e[t].objects[a];o.visible=n.visible,o.renderOrder=n.renderOrder,this._updateMaterial(o,n,r)}}},t.prototype._updateObjects=function(){var e=this.json.views.translate;console.log("updateObjects moveto: ",e),this.allGroups.position.set(e[0],e[1],e[2])},t.prototype.centreObjects=function(){if(console.log("Center objects",this.bbox),null!==this.bbox&&void 0!==this.bbox){var e=(this.bbox.min.x+this.bbox.max.x)/2,t=(this.bbox.min.y+this.bbox.max.y)/2,s=(this.bbox.min.z+this.bbox.max.z)/2;this.json.views.translate=[-e,-t,-s],this._updateObjects()}},t.prototype.resetTranslate=function(){this.json.views.translate=[0,0,0],this._updateObjects()},t.prototype.resetRenderOrder=function(){console.log("resetRenderOrder");let e=this.json.objects;for(var t=0;t<e.length;t++)this.json.objects[t].renderOrder=0;this.updateScene()},t.prototype.updateBackground=function(){this.renderer.setClearColor(new THREE.Color(this.json.views.backgroundColour[0]/255,this.json.views.backgroundColour[1]/255,this.json.views.backgroundColour[2]/255))},t.prototype.updateAxis=function(){this.axis&&(this.axis.visible=this.json.views.showAxis)},t.prototype.updateAll=function(){var e=Math.max(Math.abs(this.bbox.max.x-this.bbox.min.x),Math.abs(this.bbox.max.y-this.bbox.min.y));e=Math.max(e,Math.abs(this.bbox.max.z-this.bbox.min.z));var t=this.json.views.camera;null!==t&&void 0!==t?(this.camera.matrix.fromArray(t.matrix),this.camera.near=t.near,this.camera.far=t.far,null!==t.up&&void 0!==t.up&&this.camera.up.fromArray(t.up),this.camera.matrix.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrixWorld(!0),this.camera.updateProjectionMatrix()):(this.camera.near=.001*e,this.camera.far=10*e,this.camera.position.z=1.6*e,this.camera.updateProjectionMatrix()),this._updateObjects(),this.updateAxis(),this.updateBackground(),this.updateScene()},t.prototype.resizeDisplayGL=function(){this.controls.handleResize(),this.recalcAspectRatio(),this.renderer.setSize(this.canvas.offsetWidth,this.canvas.offsetHeight,!1),this.updateCamera()},t.prototype.recalcAspectRatio=function(){this.aspectRatio=0===this.canvas.offsetHeight?1:this.canvas.offsetWidth/this.canvas.offsetHeight},t.prototype.resetCamera=function(){this.camera.position.copy(this.cameraDefaults.posCamera),this.cameraTarget.copy(this.cameraDefaults.posCameraTarget),this.updateCamera()},t.prototype.updateCamera=function(){this.camera.aspect=this.aspectRatio,this.camera.lookAt(this.cameraTarget),this.camera.updateProjectionMatrix()},t.prototype.switchCameraControl=function(e){if("Fly control"===e){this.controls&&(this.controls.dispose(),this.controls=null),this.controls=new THREE.FlyControls(this.camera,this.renderer.domElement);let e=this.controls;e.movementSpeed=Math.max(this.maxModelSize/6,1),e.rollSpeed=.25,e.dragToLook=!0,e.autoForward=!1}else this.controls&&(this.controls.dispose(),this.controls=null),this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement)},t.prototype.render=function(){this.renderer.autoClear||this.renderer.clear();var e=this.clock.getDelta();this.controls.update(e),this.renderer.render(this.scene,this.camera)},t.prototype.generateThumbnail=function(e){this.renderer.render(this.scene,this.camera),resizeImage(this.renderer.domElement.toDataURL(),function(t){e(t)})},t}(),app=new PrevisMeshRenderer(document.getElementById("meshviewer")),resizeWindow=function(){app.resizeDisplayGL()},render=function(){requestAnimationFrame(render),app.render(),app.loaded&&!1===gHasThumbnail&&(gHasThumbnail=!0,saveThumbnail())},centreObjects=function(){app.centreObjects()},resetTranslate=function(){app.resetTranslate()},resetRenderOrder=function(){app.resetRenderOrder(),buildGui()},resetMessage=function(){showMessage("")};socket.on("savemeshjson",function(e){console.log("savemeshjson"),console.log(e),"error"==e.status?(showMessage("Can not save view parameters!"),setTimeout(resetMessage,4e3)):(showMessage("Saved settings successfully!"),setTimeout(resetMessage,4e3))});var saveSettings=function(){if(null===gTag||void 0===gTag)return;if(gTag.includes("000000_"))return showMessage("Sorry, cannot save an example!"),void setTimeout(resetMessage,4e3);showMessage("Saving settings...",!0);var e=Object.assign({},app.json);const t={near:app.camera.near,far:app.camera.far,matrix:app.camera.matrix.toArray(),up:app.camera.up.toArray()};e.views.camera=t,socket.emit("savemeshjson",{tag:gTag,dir:gDir,preset:gPreset,jsonStr:JSON.stringify(e,null,4)})};function saveSettingsAs(){let e=new Date,t=e.getYear()+""+e.getMonth()+e.getDay()+"-"+e.getHours()+e.getMinutes();var s=prompt("Save current settings as",t);if(null!==s){if(""===s)return showMessage("Error! Cannot save empty preset!"),void setTimeout(resetMessage,3e3);s=s.replace(/ /g,"_"),gPreset=s,saveSettings(),socket.emit("getsavelist",{type:"mesh",tag:gTag,dir:gDir})}}var loadSettings=function(){showMessage("Load settings from server!"),app.loadJsonConfig(gPreset,function(){buildGui(),app.updateAll(),showMessage("Settings have been loaded successfully!"),setTimeout(resetMessage,4e3)})},saveThumbnail=function(){showMessage("Save current display as tag thumbnail"),resizedImg=app.generateThumbnail(function(e){socket.emit("savethumbnail",{type:"mesh",tag:gTag,dir:gDir,base64:e})})},buildGui=function(){const e=app.json;console.log("buildGui",e);var t={Preset:gPreset,saveSettings:saveSettings,saveSettingsAs:saveSettingsAs,saveThumbnail:saveThumbnail,cameraControl:cameraControlList[0],views:{background:e.views.backgroundColour,centreObjects:centreObjects,resetTranslate:resetTranslate,showAxis:e.views.showAxis,resetRenderOrder:resetRenderOrder},objects:e.objects};gGui&&gGui.destroy();var s=gGui=new dat.GUI;(hPreset=s.add(t,"Preset",presetList).name("Preset").listen()).onFinishChange(function(e){gPreset=e,loadSettings()}),gTag.includes("000000")||(s.add(t,"saveSettings").name("Save"),s.add(t,"saveSettingsAs").name("Save as"),s.add(t,"saveThumbnail").name("Save thumbnail")),s.add(t,"cameraControl",cameraControlList).name("Camera control").listen().onFinishChange(function(e){app.switchCameraControl(e)});var a=s.addFolder("Views");console.log(t.views),a.addColor(t.views,"background").name("Background").onChange(function(t){e.views.backgroundColour=t,app.updateBackground()}),a.add(t.views,"showAxis").name("Show axes").onChange(function(t){e.views.showAxis=t,app.updateAxis()}),a.add(t.views,"centreObjects").name("Centre objects"),a.add(t.views,"resetTranslate").name("Reset translate"),a.add(t.views,"resetRenderOrder").name("Reset ren order");var o=s.addFolder("Mesh groups");o.open();for(var n=0;n<t.objects.length;n++){var r=o.addFolder(t.objects[n].name+" ("+t.objects[n].objects.length+")"),i=r.add(t.objects[n],"alpha").min(0).max(1).step(.05);i.index=n,i.onChange(function(e){t.objects[this.index].alpha=e,app.updateScene()});for(var l=!1,c=0;c<t.objects[n].objects.length;c++)if(!1===t.objects[n].objects[c].hasmtl){l=!0;break}if(l){console.log(t.objects[n]);var d=r.addColor(t.objects[n],"colour");d.index=n,d.onChange(function(e){console.log("hColour",this.index,e),t.objects[this.index].colour=e,app.updateScene()})}var h=r.add(t.objects[n],"visible");h.index=n,h.onChange(function(e){t.objects[this.index].visible=e,app.updateScene()});var u=r.add(t.objects[n],"renderOrder");u.index=n,u.onChange(function(e){const s=Math.round(e);t.objects[this.index].renderOrder=s<0?0:s,app.updateScene()})}};window.addEventListener("resize",resizeWindow,!1),socket.on("getsavelist",function(e){"error"===e.status?(showMessage("Error! Cannot get save list"),setTimeout(resetMessage,3e3)):"done"==e.status&&(presetList=e.result,updateDatDropdown(hPreset,presetList))}),socket.on("savethumbnail",function(e){"error"===e.status?showMessage("Error! Cannot save thumbnail"):showMessage("Success: thumbnail saved"),setTimeout(resetMessage,3e3)}),checkAndLoadPrevisTag(gTag,"",function(e){console.log("success: now can load data",e),console.log("Starting initialisation phase..."),gDir=e.dir||gTag,gHasThumbnail=!!e.hasThumbnail&&e.hasThumbnail,app.initGL(),app.resizeDisplayGL(),app.initContent(gPreset,function(){buildGui(),socket.emit("getsavelist",{type:"mesh",tag:gTag,dir:gDir})}),render()});