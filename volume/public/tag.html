<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Monash MIVP Cave2 Volume Renderer - Tag</title>

    <!-- Bootstrap style-->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    <!-- Page style -->
    <link rel="stylesheet" href="css/style.css">

</head>

<body>
    <div id="header"></div>
    
    <div class="help-block"></div>
    <div class="container">
        <form class="form-inline" role="form">
            <div class="form-group">
                <label>Input tag: </label>
                <input id="input_tag" type="text" placeholder="ab1122" class="form-control">
            </div>
            <button type="button" id="tag_btnGo" class="btn btn-default">GO</button>
        </form>
        
        <div class="help-block"></div>
        <div id="result_div"></div>
        <div id="grid_div" class="grid"></div>
    </div>
    
    <div id="footer"></div>
    
    <!-- SCRIPT -->
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
    <script src="lib/jquery/jquery.cookie.js" type="text/javascript"></script>
    <script src="lib/jquery/jquery.imagesloaded.js" type="text/javascript"></script>
    <!-- Bootstrap-->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- Grid block-->
    <script src="https://npmcdn.com/masonry-layout@4.0/dist/masonry.pkgd.min.js"></script>
    <!-- socket.io -->
    <script src="https://cdn.socket.io/socket.io-1.4.3.js"></script>
    
    <script type="text/javascript">
        $('#header').load("header.html");
   		$('#footer').load("footer.html");
    
        //init
   		
   		//implement
   		var socket = io();
   		
        $("#tag_btnGo").click(function(event){
            var input_tag = $("#input_tag").val().trim();
            if(input_tag == '') {
                alert("Please input your query");
                return;
            } 
            
            console.log(input_tag);
           
            socket.emit("processtag", { tag: input_tag });
           
        }); // end daris_btnSearch clicked
        
        socket.on("processtag", function (data) {
            console.log(data);
            if(data.status === "error") {
                var result_div = document.getElementById("result_div");
                result_div.innerHTML = "";
                result_div.innerHTML = "<b>Not found " + data.result.code + "</b>";
                var grid_div = document.getElementById("grid_div");
                grid_div.innerHTML = "";
                return;
            }
            else if(data.status === "done") {
                var result_div = document.getElementById("result_div");
                result_div.innerHTML = "";
                
                var tag_label = document.createElement("label");
                tag_label.setAttribute("class", "result_label");
                tag_label.innerHTML = "Tag: " + data.result.tag;
                
                var type_label = document.createElement("label");
                type_label.setAttribute("class", "result_label");
                type_label.innerHTML = "Type: " + data.result.type + " (" + data.result.source + ")";
                
                var d = new Date(data.result.date);
                var date_label = document.createElement("label");
                date_label.setAttribute("class", "result_label");
                date_label.innerHTML = "Date: " + d.toString(); 
                
                result_div.appendChild(tag_label); 
                result_div.appendChild(type_label); 
                result_div.appendChild(date_label);
                
                if(data.result.type === "volume" && data.result.source === "localupload") {
                    generateLocalUploadGrid(data.result.volumes);
                }
                else if(data.result.type === "volume" &&  data.result.source === "daris") {
                    generateDarisGrid(data.result);
                }
                else {
                    console.log("invalid data type");
                }
            }
        });
        
        function generateLocalUploadGrid(volumes) {
            var grid_div = document.getElementById("grid_div");
            grid_div.innerHTML = "";
            
            for(var i=0; i < volumes.length; i++) {
                var vol = volumes[i];
                
                var grid_item = document.createElement("div");
                grid_item.setAttribute("class", "grid-item");
                
                var img_div = document.createElement("div");
                var img_a = document.createElement("a");
                img_a.href = vol.png; img_a.target = "_blank";
                var img = document.createElement("img");
                img.setAttribute("class", "result_img");
                img.src = vol.thumb;
                img_a.appendChild(img);
                img_div.appendChild(img_a);
                grid_item.appendChild(img_div);
            
                var header_label = document.createElement("label");
                header_label.setAttribute("class", "result_label");
                header_label.innerHTML = "Vol " + (i+1).toString() + " (" + vol.res + ")";
                grid_item.appendChild(header_label);
                
                var view_button = document.createElement("button");
                view_button.setAttribute("class", "view_button");
                view_button.setAttribute("id", vol.json);
                view_button.innerHTML = 'View';
                view_button.onclick = function () {
                    window.open('sharevol/index.html?data=' + $(this).prop('id') + '&reset', target="_blank");
                };
                grid_item.appendChild(view_button);
                
                grid_div.appendChild(grid_item);
            }
            
            $("#grid_div").imagesLoaded( function(){
                 $("#grid_div").masonry({
                    // options
                    itemSelector : '.grid-item',
                    columnWidth : 280
                    //gutter: 20
                });
            });
        }
        
        function generateDarisGrid(data) {
            var grid_div = document.getElementById("grid_div");
            grid_div.innerHTML = "";
            
            var cid = data.cid;
            var res = data.res;
            var datadir = data.datadir;
            var url = data.url;
            
            for(var i=0; i < cid.length; i++) {
               
                var grid_item = document.createElement("div");
                grid_item.setAttribute("class", "grid-item");
                
                var img_div = document.createElement("div");
                var img_a = document.createElement("a");
                img_a.href = url + cid[i] + '/0001.png'; 
                img_a.target = "_blank";
                var img = document.createElement("img");
                img.setAttribute("class", "result_img");
                img.src = url + cid[i] + '/0001_thumb.png';
                img_a.appendChild(img);
                img_div.appendChild(img_a);
                grid_item.appendChild(img_div);
            
                var header_label = document.createElement("label");
                header_label.setAttribute("class", "result_label");
                header_label.innerHTML = cid[i] + " (" + res[i] + ")";
                grid_item.appendChild(header_label);
                
                var view_button = document.createElement("button");
                view_button.setAttribute("class", "view_button");
                view_button.setAttribute("id", url + cid[i] + "/0001.json");
                view_button.innerHTML = 'View';
                view_button.onclick = function () {
                    window.open('sharevol/index.html?data=' + $(this).prop('id') + '&reset', target="_blank");
                };
                grid_item.appendChild(view_button);
                
                grid_div.appendChild(grid_item);
            }
            
            $("#grid_div").imagesLoaded( function(){
                 $("#grid_div").masonry({
                    // options
                    itemSelector : '.grid-item',
                    columnWidth : 280,
                    gutter: 20
                });
            });
            
        }
        
    </script>
   
</body>