<!DOCTYPE html>
<!--[if IE 8]>
<html id="ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 8) ]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
<link href='https://fonts.googleapis.com/css?family=Electrolize' rel='stylesheet' type='text/css'>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loading 3D models in WebGL | Nervous System blog</title>
</head>
	<div id="main" class="clear-fix">
		  <div id="primary" class="site-content">
          <p>For a new app we&#8217;re working on, we finally came upon the task of loading external 3D geometry. I wanted to store and load meshes with as little bandwidth and processing as possible. I&#8217;m sure this has been done before, but here is how I approached it.</p>
          <p><canvas id="loadvbo" width=400 height=400></canvas></p>
<pre>
<script id="shader-fs" type="x-shader/x-fragment">
precision highp float;

varying vec4 vPosition;
varying vec3 vNormal;
            
void main(void) {
  vec3 normal = vNormal;
  
  vec3 lightDir = normalize(vec3(1,1,1));
  float brightness = (dot(lightDir,normal)+1.0)/2.0; //-1,1.5  
  gl_FragColor = vec4(brightness,brightness, brightness,1);
}
</script>
<script id="shader-vs" type="x-shader/x-vertex">
attribute vec3 aVertexPosition;
attribute vec3 aVertexNormal;
    
uniform mat4 uMVMatrix;
uniform mat4 uPMatrix;
uniform mat3 uNMatrix;

varying vec4 vPosition;
varying vec3 vNormal;
void main(void) {
   gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
   vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);//uMVMatrix * 
   vNormal = uNMatrix * normalize(aVertexNormal);
}
</script><script type="text/javascript" src="../../public/sharevol/lib/gl-matrix.js"></script><script type="text/javascript" src="webgl-utils.js"></script><script type="text/javascript" src="loadwtm.js"></script><script type="text/javascript">

var loadvboExample = (function () {
var gl;
var vbo = {};
var shaderProgram;
var rot = 0;
var mvMatrix = mat4.create();
var tempMatrix2 = mat4.create();
var tempMatrix = mat4.create();
var pMatrix = mat4.create();
var nMatrix = mat3.create();

window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       || 
              window.webkitRequestAnimationFrame || 
              window.mozRequestAnimationFrame    || 
              window.oRequestAnimationFrame      || 
              window.msRequestAnimationFrame     || 
              function( callback ){
                window.setTimeout(callback, 1000 / 60);
              };
    })();

var init = function() {
  initGL(document.getElementById('loadvbo'));
  if(gl) {
      gl.enable(gl.DEPTH_TEST);
	var fragmentShader, vertexShader;
	fragmentShader = getShader(gl, "shader-fs");
	vertexShader = getShader(gl, "shader-vs");
	
	shaderProgram= gl.createProgram();
	gl.attachShader(shaderProgram, vertexShader);
	gl.attachShader(shaderProgram, fragmentShader);
	gl.linkProgram(shaderProgram);

	if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
		alert("Could not initialise shaders");
	}
	
	shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, "aVertexPosition");
	shaderProgram.vertexNormalAttribute = gl.getAttribLocation(shaderProgram, "aVertexNormal");
	
	shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, "uPMatrix");
	shaderProgram.mvMatrixUniform = gl.getUniformLocation(shaderProgram, "uMVMatrix");
	shaderProgram.nMatrixUniform = gl.getUniformLocation(shaderProgram, "uNMatrix");
    
    loadVBO("wp-content/uploads/interstice_s.vbo",vbo,gl);
    anim();
  }
};

function anim() {
  requestAnimFrame(anim,60);
  drawGL();
}

mat4.toInverseMat3=function(a,b){var c=a[0],d=a[1],e=a[2],g=a[4],f=a[5],h=a[6],i=a[8],j=a[9],k=a[10],l=k*f-h*j,o=-k*g+h*i,m=j*g-f*i,n=c*l+d*o+e*m;if(!n)return null;n=1/n;b||(b=mat3.create());b[0]=l*n;b[1]=(-k*d+e*j)*n;b[2]=(h*d-e*f)*n;b[3]=o*n;b[4]=(k*c-e*i)*n;b[5]=(-h*c+e*g)*n;b[6]=m*n;b[7]=(-j*c+d*i)*n;b[8]=(f*c-d*g)*n;return b};

function drawGL() {
  gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
  gl.useProgram(shaderProgram);
   rot += Math.PI/300.0;
	mat4.perspective(pMatrix,45, gl.viewportWidth / gl.viewportHeight, 0.1, 300.0);
    mat4.identity(mvMatrix);	
	mat4.rotateY(mvMatrix, mvMatrix,rot);
	
	mat4.multiply(tempMatrix,mat4.lookAt(tempMatrix2,[0,0,150],[0,0,0],[0,-1,0]),mvMatrix);
	var temp = mvMatrix;
	mvMatrix = tempMatrix;
	tempMatrix = temp;
	mat4.toInverseMat3(mvMatrix, nMatrix);
	mat3.transpose(nMatrix,nMatrix);

	gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);
	gl.enableVertexAttribArray(shaderProgram.vertexNormalAttribute);
	gl.bindBuffer(gl.ARRAY_BUFFER, vbo.vertexBuffer);
	gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, 3, gl.FLOAT, false,24,0);
	gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, 3, gl.FLOAT, false,24,12);
	gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
	gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
	gl.uniformMatrix3fv(shaderProgram.nMatrixUniform, false, nMatrix);
	
	
	gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, vbo.indexBuffer);
	gl.drawElements(gl.TRIANGLES,vbo.numFaces*3, gl.UNSIGNED_SHORT,0);

}

function initGL(canvas) {
	try {
		gl = canvas.getContext("experimental-webgl"); //preserve drawing buffer
		gl.viewportWidth = canvas.width;
		gl.viewportHeight = canvas.height;
	} catch (e) {
	}
	if (!gl) {
          canvas.display = "none";
	}
}

function getShader(gl, id) {
	var shaderScript = document.getElementById(id);
	if (!shaderScript) {
		return null;
	}

	var str = "";
	var k = shaderScript.firstChild;
	while (k) {
		if (k.nodeType == 3) {
			str += k.textContent;
		}
		k = k.nextSibling;
	}

	var shader;
	if (shaderScript.type == "x-shader/x-fragment") {
		shader = gl.createShader(gl.FRAGMENT_SHADER);
	} else if (shaderScript.type == "x-shader/x-vertex") {
		shader = gl.createShader(gl.VERTEX_SHADER);
	} else {
		return null;
	}

	gl.shaderSource(shader, str);
	gl.compileShader(shader);

	if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
		alert(gl.getShaderInfoLog(shader));
		return null;
	}

	return shader;
}
return init;
}

)();

loadvboExample();
</script></pre>

</div></div>
</body>
</html>

