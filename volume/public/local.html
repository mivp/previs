<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Monash MIVP Cave2 Volume Renderer</title>

    <!-- Bootstrap style-->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    <!-- style -->
    <link rel="stylesheet" href="css/style.css">

</head>

<body>
    <div id="header"></div>

    <div class="container">
        <h3 class="section-heading">Upload Data</h3>
        <p> Formats Supported: </p>
        <ul>
            <li> TIFF Image Stack (.zip file of an indexed TIFF image stack) </li>
        </ul>

        <form id="upload_form" action="/localupload" enctype="multipart/form-data" method="post">
            <input type="file" name="upload" id="fileup"><br><br>
            <input type="submit" value="Upload" onclick="return checkForm()" class="btn btn-default">
        </form>
        <div id="local_upload_message">
            <img id="process_img" src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH+GkNyZWF0ZWQgd2l0aCBhamF4bG9hZC5pbmZvACH5BAAKAAAAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQACgABACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkEAAoAAgAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkEAAoAAwAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkEAAoABAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQACgAFACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQACgAGACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAAKAAcALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA=="/>
            <label id="message_label">Uploading... please wait!</label>
        </div>

        <div id="local_upload_result_container">
            <div class="row">
                <a href="#" target="_blank" id="png_link"><img id="thumb_img" src=""/></a>
            </div>
            <div class="row">
                <label id="tag_label"></label>
            </div>
            <div class="row">
                <a href="#" target="_blank" id="view_web"><h4>View vol with sharevol</h4></a>
                <!--
                <button id="download_xrw">Download xrw file</button>
                <button id="download_png">Download png file</button>
                -->
            </div>
        </div>
    </div>    

	<div id="footer"></div>
	
	<!-- SCRIPT -->
	<!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!-- Bootstrap-->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- socket.io -->
    <script src="https://cdn.socket.io/socket.io-1.4.3.js"></script>
    
    <script>
        var socket = io();
        
        $('#header').load("header.html");
   		$('#footer').load("footer.html");
   		
   		function checkForm()
        {
            var fup = $('#fileup').val();
            if(fup == '' || fup == undefined){
    
                alert("Please select a file to upload");
                return false;
            }
            else {
                var file_extension = fup.split('.').pop();
                if(file_extension != 'zip') {
                    alert("Please select a zip file");
                    return false;
                }
                document.getElementById("local_upload_message").style.display = "block";
                document.getElementById("upload_form").style.display = "none";
                return true;
            }
        }

        var uploadedfile = location.search.split('file=')[1];
        if(uploadedfile !== undefined) {
            console.log("file: " + uploadedfile);
            document.getElementById("upload_form").style.display = "none";
            document.getElementById("local_upload_message").style.display = "block";
            lmessage = document.getElementById("message_label");
            lmessage.style.color = 'blue';
            lmessage.innerHTML = "Uploaded successfully! Now working... ";
            process_img = document.getElementById("process_img");
            process_img.style.visibility = 'visible';  

            socket.emit('processuploadfile', {task: "process", file: uploadedfile});
        }

        socket.on('processuploadfile', function (data) {
            lmessage = document.getElementById("message_label");
            process_img = document.getElementById("process_img");
            console.log(data);
            if(data.status === 'working') {   
                process_img.style.visibility = 'visible';                      
                lmessage.style.color = 'blue';
                lmessage.innerHTML = "Working... " + data.result;
            }
            else if (data.status === 'done') {
                process_img.style.visibility = 'hidden';
                lmessage.style.color = 'blue';
                lmessage.innerHTML = '';
                $("#local_upload_message").hide();
                document.getElementById("thumb_img").src=data.thumb;
                document.getElementById("png_link").href=data.png;
                document.getElementById("tag_label").innerHTML = '<h4>Tag: <b><font color="red">' + data.tag + '</font></b> Please write down for later use</h4>';
                document.getElementById("view_web").href='sharevol/index.html?data=' + data.json;
                $("#local_upload_result_container").show();
                //window.open('sharevol/index.html?data=' + data.result, target="_blank");
            }
            else if (data.status === 'error') {
                lmessage.style.color = 'red';
                lmessage.innerHTML = "Error: " + data.result;
                process_img.style.visibility = 'hidden';
                alert(data.detail);
            }
        });
        
    </script>
</body>
