function getSearchVariable(t,e){for(var i=window.location.search.substring(1),r=i.split("&"),o=0;o<r.length;o++){var n=r[o].split("=");if(unescape(n[0])==t)return unescape(n[1])}return e}function getImageDataURL(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");i.drawImage(t,0,0);var r=e.toDataURL("image/png");return r}function setAll(t,e){for(var i=document.getElementsByClassName(e),r=0;r<i.length;r++)i[r].style.display=t}function getSourceFromElement(t){var e=document.getElementById(t);if(!e)return null;for(var i="",r=e.firstChild;r;)3==r.nodeType&&(i+=r.textContent),r=r.nextSibling;return i}function removeChildren(t){if(t.hasChildNodes())for(;t.childNodes.length>0;)t.removeChild(t.firstChild)}function requestFullScreen(t){var e=document.getElementById(t);e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen()}function typeOf(t){var e=typeof t;return"object"===e&&(t?"number"!=typeof t.length||t.propertyIsEnumerable("length")||"function"!=typeof t.splice||(e="array"):e="null"),e}function isEmpty(t){var e,i;if("object"===typeOf(t))for(e in t)if(i=t[e],void 0!==i&&"function"!==typeOf(i))return!1;return!0}function ajaxReadFile(t,e,i,r,o){var n=new XMLHttpRequest,s=0;if(void 0!=r&&("number"==typeof r?s=r:n.onprogress=r),n.onreadystatechange=function(){if(s>0&&n.readyState>2){var i=parseInt(n.responseText.length);r&&setProgress(i/s*100)}4==n.readyState&&(200==n.status?(r&&setProgress(100),OK.debug("RECEIVED: "+t),e&&e(n.responseText,t)):e?e("Error: "+n.status+" : "+t):OK.debug("Ajax Read File Error: returned status code "+n.status+" "+n.statusText))},i){var a=new Date;n.open("GET",t+"?d="+a.getTime(),!0)}else n.open("GET",t,!0);for(var l in o)n.setRequestHeader(l,o[l]);n.send(null)}function readURL(t,e,i){var r=new XMLHttpRequest,o=0;if(void 0!=i&&("number"==typeof i?o=i:r.onprogress=i),r.onreadystatechange=function(){if(o>0&&r.readyState>2){var t=parseInt(r.responseText.length);i&&setProgress(t/o*100)}},e){var n=new Date;r.open("GET",t+"?d="+n.getTime(),!1)}else r.open("GET",t,!1);return r.overrideMimeType("text/plain; charset=x-user-defined"),r.send(null),200!=r.status?"":(i&&setProgress(100),r.responseText)}function updateProgress(t){t.lengthComputable&&(setProgress(t.loaded/t.total*100),OK.debug(t.loaded+" / "+t.total))}function setProgress(t){var e=Math.round(t);$S("progressbar").width=3*e+"px",$("progressstatus").innerHTML=e+"%"}function ajaxPost(t,e,i,r,o){var n=new XMLHttpRequest;if(void 0!=r&&(n.upload.onprogress=r),n.onreadystatechange=function(){4==n.readyState&&(200==n.status?(r&&setProgress(100),OK.debug("POST: "+t),i&&i(n.responseText)):i?i("Error, status:"+n.status):OK.debug("Ajax Post Error: returned status code "+n.status+" "+n.statusText))},n.open("POST",t,!0),"string"==typeof e&&(n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.setRequestHeader("Content-length",e.length)),o)for(key in o)n.setRequestHeader(key,o[key]);n.send(e)}function MouseEventHandler(t,e,i,r,o,n,s){this.click=t,this.wheel=e,this.move=i,this.down=r,this.up=o,this.leave=n,this.pinch=s}function Mouse(t,e,i){this.element=t,this.handler=e,this.disabled=!1,this.isdown=!1,this.button=null,this.dragged=!1,this.x=0,this.x=0,this.absoluteX=0,this.absoluteY=0,this.lastX=0,this.lastY=0,this.slider=null,this.spin=0,this.moveUpdate=!1,this.enableContext=!!i,t.addEventListener("onwheel"in document?"wheel":"mousewheel",handleMouseWheel,!1),t.onmousedown=handleMouseDown,t.onmouseout=handleMouseLeave,document.onmouseup=handleMouseUp,document.onmousemove=handleMouseMove,t.addEventListener("touchstart",touchHandler,!0),t.addEventListener("touchmove",touchHandler,!0),t.addEventListener("touchend",touchHandler,!0),t.oncontextmenu=function(){return this.mouse.enableContext}}function mousePageCoord(t){var e,i;return t.pageX||t.pageY?(e=t.pageX,i=t.pageY):(e=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),[e,i]}function elementRelativeCoord(t,e){var i=findElementPos(t);e[0]-=i[0],e[1]-=i[1]}function findElementPos(t){var e=curtop=0;do e+=t.offsetLeft,curtop+=t.offsetTop;while(t=t.offsetParent);return[e,curtop]}function getMouse(t){t||(t=window.event);var e=t.target.mouse;if(e)return e;for(var i=t.target;i!=document;)if(i=i.parentNode,i.mouse)return i.mouse;return null}function handleMouseDown(t){var e=getMouse(t);if(!e||e.disabled)return!0;var i=t||window.event;e.target=i.target,e.dragged=!1,e.update(t),e.isdown||(e.lastX=e.absoluteX,e.lastY=e.absoluteY),e.isdown=!0,dragMouse=e,e.button=t.button,document.mouse=e;var r=!0;return e.handler.down&&(r=e.handler.down(t,e)),!r&&t.preventDefault&&t.preventDefault(),r}function handleMouseUp(t){var e=document.mouse;if(!e||e.disabled)return!0;var i=!0;return e.isdown&&(e.update(t),e.handler.click&&(i=e.handler.click(t,e)),e.isdown=!1,dragMouse=null,e.button=null,e.dragged=!1),e.handler.up&&(i=i&&e.handler.up(t,e)),document.mouse=defaultMouse,!i&&t.preventDefault&&t.preventDefault(),i}function handleMouseMove(t){var e=dragMouse?dragMouse:getMouse(t);if(!e||e.disabled)return!0;e.update(t),e.deltaX=e.absoluteX-e.lastX,e.deltaY=e.absoluteY-e.lastY;var i=!0;return!e.dragged&&e.isdown&&Math.abs(e.deltaX)+Math.abs(e.deltaY)>3&&(e.dragged=!0),e.handler.move&&(i=e.handler.move(t,e)),e.moveUpdate&&(e.lastX=e.absoluteX,e.lastY=e.absoluteY),!i&&t.preventDefault&&t.preventDefault(),i}function handleMouseWheel(t){var e=getMouse(t);if(!e||e.disabled)return!0;e.update(t);var i=!1,r=t.deltaY?-t.deltaY:t.wheelDelta;return t.spin=r>0?1:-1,e.handler.wheel&&(i=e.handler.wheel(t,e)),!i&&t.preventDefault&&t.preventDefault(),i}function handleMouseLeave(t){var e=getMouse(t);if(!e||e.disabled)return!0;var i=!0;return e.handler.leave&&(i=e.handler.leave(t,e)),!i&&t.preventDefault&&t.preventDefault(),t.returnValue=i,i}function touchHandler(t){var e=t.changedTouches,i=e[0],r=null,o=!1,n=getMouse(t);switch(t.type){case"touchstart":2==t.touches.length?(n.isdown=!1,n.scaling=0):r="mousedown";break;case"touchmove":if(null!=n.scaling&&2==t.touches.length){var s=Math.sqrt((t.touches[0].pageX-t.touches[1].pageX)*(t.touches[0].pageX-t.touches[1].pageX)+(t.touches[0].pageY-t.touches[1].pageY)*(t.touches[0].pageY-t.touches[1].pageY));if(n.scaling>0){t.distance=s-n.scaling,n.handler.pinch&&(a=n.handler.pinch(t,n));var a=!0;!a&&t.preventDefault&&t.preventDefault(),t.returnValue=a}else n.scaling=s}else r="mousemove";break;case"touchend":null!=n.scaling?0==n.scaling?n.scaling=null:n.scaling=0:r="mouseup";break;default:return}if(t.touches.length>1&&(r=null),r){var l=document.createEvent("MouseEvent");l.initMouseEvent(r,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,0,null),o=!i.target.dispatchEvent(l),t.preventDefault()}}function Viewport(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r}function WebGL(t,e){if(this.program=null,this.modelView=new ViewMatrix,this.perspective=new ViewMatrix,this.textures=[],this.timer=null,!window.WebGLRenderingContext)throw"No browser WebGL support";try{this.gl=t.getContext("webgl",e)||t.getContext("experimental-webgl",e)}catch(i){throw OK.debug("detectGL exception: "+i),"No context"}if(this.viewport=new Viewport(0,0,t.width,t.height),!this.gl)throw"Failed to get context"}function WebGLProgram(t,e,i){if(this.program=null,e.indexOf("main")<0&&(e=getSourceFromElement(e)),i.indexOf("main")<0&&(i=getSourceFromElement(i)),this.gl=t,this.program&&this.gl.isProgram(this.program)&&(this.gl.isShader(this.vshader)&&(this.gl.detachShader(this.program,this.vshader),this.gl.deleteShader(this.vshader)),this.gl.isShader(this.fshader)&&(this.gl.detachShader(this.program,this.fshader),this.gl.deleteShader(this.fshader)),this.gl.deleteProgram(this.program)),this.program=this.gl.createProgram(),this.vshader=this.compileShader(e,this.gl.VERTEX_SHADER),this.fshader=this.compileShader(i,this.gl.FRAGMENT_SHADER),this.gl.attachShader(this.program,this.vshader),this.gl.attachShader(this.program,this.fshader),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw"Could not initialise shaders: "+this.gl.getProgramInfoLog(this.program)}function ViewMatrix(){this.matrix=mat4.create(),mat4.identity(this.matrix),this.stack=[]}function Palette(t,e){if(this.premultiply=e,this.background=new Colour("rgba(0,0,0,0)"),this.colours=[],this.slider=new Image,this.slider.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAPCAYAAAA2yOUNAAAAj0lEQVQokWNIjHT8/+zZs//Pnj37/+TJk/9XLp/+f+bEwf9HDm79v2Prqv9aKrz/GUYVEaeoMDMQryJXayWIoi0bFmFV1NWS+z/E1/Q/AwMDA0NVcez/LRsWoSia2luOUAADVcWx/xfO6/1/5fLp/1N7y//HhlmhKoCBgoyA/w3Vyf8jgyyxK4CBUF8zDAUAAJRXY0G1eRgAAAAASUVORK5CYII=",!t)return this.colours.push(new ColourPos("rgba(255,255,255,1)",0)),void this.colours.push(new ColourPos("rgba(0,0,0,1)",1));var i=!1;if("string"==typeof t)for(var r,o=t.split(/[\n;]/),n=0;n<o.length;n++){var s=o[n].trim();if(s){var a=s.split("=");if("Background"==a[0])this.background=new Colour(a[1]);else if("P"==a[0][0])r=parseFloat(a[1]);else if("C"==a[0][0]){if(this.colours.push(new ColourPos(a[1],r)),1==r)break}else 2==a.length?this.colours.push(new ColourPos(a[1],a[0])):(i=!0,this.colours.push(new ColourPos(s)))}}else{for(var l=0;l<t.length;l++)void 0==t[l].position&&(i=!0),this.colours.push(new ColourPos(t[l].colour,t[l].position));t.background&&(this.background=new Colour(t.background))}if(i)for(var l=0;l<this.colours.length;l++)this.colours[l].position=l*(1/(this.colours.length-1));this.sort();for(var h=!1,u=0;u<this.colours.length;u++)this.colours[u].colour.alpha>0&&(h=!0),this.colours[u].colour.alpha>1&&(this.colours[u].colour.alpha=1);if(!h)for(var u=0;u<this.colours.length;u++)this.colours[u].colour.alpha=1}function ColourPos(t,e){if(void 0==e?this.position=0:this.position=parseFloat(e),!(this.position>=0&&this.position<=1))throw"Invalid Colour Position: "+e;t?"object"==typeof t?this.colour=t:this.colour=new Colour(t):this.colour=new Colour("#000000")}function Colour(t){"undefined"==typeof t?this.set("#ffffff"):"string"==typeof t?this.set(t):"object"==typeof t?"undefined"!=typeof t.H?this.setHSV(t):"undefined"!=typeof t.red?(this.red=t.red,this.green=t.green,this.blue=t.blue,this.alpha=t.alpha):t.R?(this.red=t.R,this.green=t.G,this.blue=t.B,this.alpha="undefined"==typeof t.A?1:t.A):(this.red=t[0],this.green=t[1],this.blue=t[2],this.red<=1&&this.green<=1&&this.blue<=1&&(this.red=Math.round(255*this.red),this.green=Math.round(255*this.green),this.blue=Math.round(255*this.blue)),this.alpha="undefined"==typeof t[3]?1:t[3]):this.fromInt(t)}function MoveWindow(t){if(t){if(this.element=$(t),!this.element)return alert("No such element: "+t),null;this.mouse=new Mouse(this.element,this),this.mouse.moveUpdate=!0,this.element.mouse=this.mouse}}function scale(t,e,i,r){return clamp(r*t/e,i,r)}function clamp(t,e,i){return Math.max(e,Math.min(i,t))}function ColourPicker(t,e){function i(t,e,i){var r=document.createElement("div");return r.id=t,e&&(r.innerHTML=e),i&&(r.style.cssText=i),r}var r=document.body,o="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4jWP4TwAcOHAAL2YYNWBYGEBIASEwasCwMAAALvidroqDalkAAAAASUVORK5CYII=",n="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAFCAYAAAC5Fuf5AAAAKklEQVQokWP4////fwY6gv////9n+A8F9LIQxVJaW4xiz4D5lB4WIlsMAPjER7mTpG/OAAAAAElFTkSuQmCC",s="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAALUlEQVQYlWNgQAX/kTBW8B8ZYFMIk0ARQFaIoQCbQuopIspNRPsOrpABSzgBAFHzU61KjdKlAAAAAElFTkSuQmCC",a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAEG0lEQVQ4jQEQBO/7APz8/Pz7+/vx+/v75Pr6+tb6+vrF+Pj4tPf396H4+PiO9/f3e/X19Wfz8/NU8PDwQuvr6zLi4uIjzs7OFZmZmQoA8PDw/O/v7/Ht7e3l7Ozs2Ozs7Mjq6uq35ubmpeXl5ZLf39+A3NzcbtXV1VvMzMxLvr6+O6ioqCyEhIQfQEBAFADk5OT84eHh8uDg4Obe3t7Z3Nzcy9nZ2brV1dWq0NDQmcrKyofCwsJ2uLi4ZKqqqlSYmJhFfX19N1lZWSsnJychANPT0/zT09Pz0NDQ6c3NzdzKysrNx8fHv8DAwK+6urqfsrKyj6mpqX+cnJxvjIyMX3l5eVBeXl5EPz8/ORsbGy8Aw8PD/MHBwfS+vr7qurq63ra2ttKxsbHErKystaOjo6eampqXj4+PiYODg3lycnJrXl5eX0hISFIuLi5IEBAQPwCwsLD9r6+v9aysrOynp6fioqKi1p2dncmVlZW8jo6OroODg6F5eXmUa2trhl1dXXlLS0ttNzc3YiIiIlkNDQ1RAJ6env2bm5v2l5eX7pSUlOWPj4/aiIiIz4GBgcN5eXm3cHBwq2RkZJ5XV1eSSkpKhzk5OX0qKipzGBgYawgICGMAioqK/YeHh/eDg4PvgICA6Hp6et90dHTVbW1ty2VlZcBcXFy1UVFRqkZGRqA6OjqWLS0tjSEhIYQSEhJ9BgYGdwB2dnb+c3Nz+HFxcfJra2vrZmZm42JiYttaWlrRUlJSyUtLS79CQkK2Nzc3rS0tLaQiIiKdGBgYlQ4ODo8EBASKAGNjY/5gYGD5XV1d9FpaWu5VVVXnTk5O4UlJSdlCQkLRPDw8yTQ0NMEqKiq7IiIisxkZGa0RERGmCgoKoQMDA5wAUFBQ/k9PT/pKSkr3R0dH8kNDQ+w+Pj7mOTk54DMzM9otLS3TJycnzSAgIMgZGRnBExMTvA0NDbcHBweyAwMDrwA9PT3+PDw8+zo6Ovg2Njb0MzMz8DAwMOwqKirnJSUl4iEhId4cHBzYFxcX1BISEtAODg7KCQkJxwQEBMQBAQHBAC0tLf4rKyv9Kioq+iYmJvclJSX0ISEh8R4eHu4aGhrqFhYW5xMTE+MQEBDgDQ0N3AgICNkGBgbWBAQE0wAAANEAHh4e/h0dHf0bGxv7Ghoa+hgYGPcWFhb2FBQU8xEREfEPDw/uDAwM7AoKCuoICAjoBgYG5gMDA+MBAQHiAAAA4QARERH+EBAQ/g8PD/0NDQ38DQ0N+wsLC/kKCgr4CAgI9wcHB/YFBQX0BAQE8wICAvIBAQHwAQEB7wAAAO8AAADuAAUFBf4FBQX+BAQE/gQEBP4DAwP+AwMD/QMDA/0CAgL8AQEB/AEBAfsAAAD7AAAA+wAAAPoAAAD6AAAA+QAAAPmq2NbsCl2m4wAAAABJRU5ErkJggg==",l='background-image: url("'+o+'");',h="cursor: crosshair; float: left; height: 170px; position: relative; width: 19px; padding: 0;"+l,u='top: 0px; left: -5px; background: url("'+n+'"); height: 5px; width: 29px; position: absolute; ',d="position: relative;";this.element=i("picker",null,"display:none; top: 58px; z-index: 20; background: #0d0d0d; color: #aaa; cursor: move; font-family: arial; font-size: 11px; padding: 7px 10px 11px 10px; position: fixed; width: 229px; border-radius: 5px; border: 1px solid #444;");var c=i("pickCURBG",null,l+" float: left; width: 12px; height: 12px; margin-right: 3px;");c.appendChild(i("pickCUR",null,"float: left; width: 12px; height: 12px; background: #fff; margin-right: 3px;")),this.element.appendChild(c);var p=i("pickRGB","R: 255 G: 255 B: 255","float: left; position: relative; top: -1px;");p.onclick="colours.picker.updateString()",this.element.appendChild(p),this.element.appendChild(i("pickCLOSE","X","float: right; cursor: pointer; margin: 0 8px 3px;")),this.element.appendChild(i("pickOK","OK","float: right; cursor: pointer; margin: 0 8px 3px;"));var f=i("SV",null,"position: relative; cursor: crosshair; float: left; height: 170px; width: 170px; margin-right: 10px; background: url('"+a+"') no-repeat; background-size: 100%;");f.appendChild(i("SVslide",null,"background: url('"+s+"'); height: 9px; width: 9px; position: absolute; cursor: crosshair")),this.element.appendChild(f);var g=i("H",null,h);g.appendChild(i("Hmodel",null,d)),g.appendChild(i("Hslide",null,u)),this.element.appendChild(g);var m=i("O",null,h+"border: 1px solid #888; left: 9px;");m.appendChild(i("Omodel",null,d)),m.appendChild(i("Oslide",null,u)),this.element.appendChild(m),r.appendChild(this.element);var v="#pickRGB:hover {color: #FFD000;} #pickCLOSE:hover {color: #FFD000;} #pickOK:hover {color: #FFD000;}",b=document.createElement("style");b.styleSheet?b.styleSheet.cssText=v:b.appendChild(document.createTextNode(v)),document.getElementsByTagName("head")[0].appendChild(b),MoveWindow.call(this,"picker"),this.savefn=t,this.abortfn=e,this.size=170,this.sv=5,this.oh=2,this.picked={H:360,S:100,V:100,A:1},this.max={H:360,S:100,V:100,A:1},this.colour=new Colour;var _,w,y,x="";for(_=0;_<=this.size;_++)w=new Colour({H:Math.round(360/this.size*_),S:100,V:100,A:1}),x+="<div class='hue' style='height: 1px; width: 19px; margin: 0; padding: 0; background: "+w.htmlHex()+";'> </div>";for($("Hmodel").innerHTML=x,x="",_=0;_<=this.size;_++)y=1-_/this.size,x+="<div class='opacity' style='height: 1px; width: 19px; margin: 0; padding: 0; background: #000;opacity: "+y.toFixed(2)+";'> </div>";$("Omodel").innerHTML=x}function GradientEditor(t,e,i,r,o){this.canvas=t,this.callback=e,this.premultiply=i,this.changed=!0,this.inserting=!1,this.editing=null,this.element=null,this.spin=0,this.scrollable=o;r||(this.picker=new ColourPicker(this.save.bind(this),this.cancel.bind(this))),this.palette=new Palette(null,i),this.canvas.mouse=new Mouse(this.canvas,this),this.canvas.oncontextmenu="return false;",this.canvas.oncontextmenu=function(){return!1}}function Slicer(t,e,i,r){this.image=e,this.res=t.volume.res,this.dims=[t.volume.res[0]*t.volume.scale[0],t.volume.res[1]*t.volume.scale[1],t.volume.res[2]*t.volume.scale[2]],this.slices=[.5,.5,.5],this.properties={},this.properties.show=!0,this.properties.X=Math.round(this.res[0]/2),this.properties.Y=Math.round(this.res[1]/2),this.properties.Z=Math.round(this.res[2]/2),this.properties.brightness=0,this.properties.contrast=1,this.properties.power=1,this.properties.usecolourmap=!1,this.properties.layout="xyz",this.flipY=!1,this.properties.zoom=1,this.container=document.createElement("div"),this.container.style.cssText="position: absolute; bottom: 10px; left: 10px; margin: 0px; padding: 0px; pointer-events: none;",r||(r=document.body),r.appendChild(this.container),t.slices&&this.load(t.slices),this.canvas=document.createElement("canvas"),this.canvas.style.cssText="position: absolute; bottom: 0px; margin: 0px; padding: 0px; border: none; background: rgba(0,0,0,0); pointer-events: none;",this.doLayout(),this.canvas.mouse=new Mouse(this.canvas,this),this.webgl=new WebGL(this.canvas),this.gl=this.webgl.gl,this.filter=this.gl.NEAREST,"linear"==i&&(this.filter=this.gl.LINEAR),this.webgl.init2dBuffers(this.gl.TEXTURE2),this.program=new WebGLProgram(this.gl,"texture-vs","texture-fs"),this.program.errors&&OK.debug(this.program.errors),this.program.setup(["aVertexPosition"],["palette","texture","colourmap","cont","bright","power","slice","dim","res","axis","select"]),this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.SCISSOR_TEST),this.loadImage(this.image),this.properties.show||this.toggle()}function SliceView(t,e,i,r,o,n){this.axis=r,this.slicer=t,this.magnify=n||1,this.origin=[.5,.5],this.rotate=o||0,this.i=0,this.j=1,0==r&&(this.i=2),1==r&&(this.j=2);var s=Math.round(t.dims[this.i]*t.properties.zoom*this.magnify),a=Math.round(t.dims[this.j]*t.properties.zoom*this.magnify);90==this.rotate?this.viewport=new Viewport(e,i,a,s):this.viewport=new Viewport(e,i,s,a),this.div=document.createElement("div"),this.div.style.cssText="padding: 0px; margin: 0px; outline: 2px solid rgba(64,64,64,0.5); position: absolute; display: inline-block; pointer-events: auto;",this.div.id="slice-div-"+r,this.div.style.left=e+"px",this.div.style.bottom=i+"px",this.div.style.width=this.viewport.width+"px",this.div.style.height=this.viewport.height+"px",this.div.mouse=new Mouse(this.div,this)}function Volume(t,e,i,r){if(this.image=e,this.canvas=document.createElement("canvas"),this.canvas.style.cssText="width: 100%; height: 100%; z-index: 0; margin: 0px; padding: 0px; background: black; border: none; display:block;",r||(r=document.body),r.appendChild(this.canvas),this.canvas.mouse=new Mouse(this.canvas,this),this.canvas.mouse.moveUpdate=!0,this.background=new Colour(4282400832),this.borderColour=new Colour(4290493371),this.width=this.height=0,this.webgl=new WebGL(this.canvas),this.gl=this.webgl.gl,this.rotating=!1,this.translate=[0,0,4],this.rotate=quat4.create(),quat4.identity(this.rotate),this.focus=[0,0,0],this.centre=[0,0,0],this.modelsize=1,this.scale=[1,1,1],this.orientation=1,this.fov=45,this.focalLength=1/Math.tan(.5*this.fov*Math.PI/180),this.resolution=t.volume.res,this.res=t.volume.res,this.dims=t.volume.scale,this.scaling=this.dims,t.volume.autoscale){var o=Math.max.apply(null,this.res);this.scaling=[this.res[0]/o*this.dims[0],this.res[1]/o*this.dims[1],this.res[2]/o*this.dims[2]]}this.tiles=[this.image.width/this.res[0],this.image.height/this.res[1]],this.iscale=[1/this.scaling[0],1/this.scaling[1],1/this.scaling[2]],this.centre=[.5*this.scaling[0],.5*this.scaling[1],.5*this.scaling[2]],this.modelsize=Math.sqrt(3),this.focus=this.centre,this.translate[2]=1.25*-this.modelsize,OK.debug("New model size: "+this.modelsize+", Focal point: "+this.focus[0]+","+this.focus[1]+","+this.focus[2]),this.linePositionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.linePositionBuffer);var n=[-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1,0,0,1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(n),this.gl.STATIC_DRAW),this.linePositionBuffer.itemSize=3,this.linePositionBuffer.numItems=6,this.lineColourBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.lineColourBuffer);var s=[1,0,0,1,1,0,0,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0,1,1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(s),this.gl.STATIC_DRAW),this.lineColourBuffer.itemSize=4,this.lineColourBuffer.numItems=6,this.box([0,0,0],[1,1,1]),this.webgl.init2dBuffers(this.gl.TEXTURE1),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.webgl.loadTexture(e,this.gl.LINEAR);var a=!!window.MSInputMethodContext;this.lineprogram=new WebGLProgram(this.gl,"line-vs","line-fs"),this.lineprogram.errors&&OK.debug(this.lineprogram.errors),this.lineprogram.setup(["aVertexPosition","aVertexColour"],["uColour","uAlpha"]),this.gl.vertexAttribPointer(this.lineprogram.attributes.aVertexPosition,this.linePositionBuffer.itemSize,this.gl.FLOAT,!1,0,0),this.gl.vertexAttribPointer(this.lineprogram.attributes.aVertexColour,this.lineColourBuffer.itemSize,this.gl.FLOAT,!1,0,0);var l="precision highp float; const highp vec2 slices = vec2("+this.tiles[0]+","+this.tiles[1]+");\n";l+=a?"#define IE11\n":"#define NOT_IE11\n";var h=i?1024:256;l+="const int maxSamples = "+h+";\n\n\n\n\n\n",OK.debug(l);var u=getSourceFromElement("volume-fs");this.program=new WebGLProgram(this.gl,"volume-vs",l+u),this.program.errors&&OK.debug(this.program.errors),this.program.setup(["aVertexPosition"],["uBackCoord","uVolume","uTransferFunction","uEnableColour","uFilter","uDensityFactor","uPower","uSaturation","uBrightness","uContrast","uSamples","uViewport","uBBMin","uBBMax","uResolution","uRange","uDenMinMax","uIsoValue","uIsoColour","uIsoSmooth","uIsoWalls","uInvPMatrix"]),this.gl.enable(this.gl.DEPTH_TEST),this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.depthFunc(this.gl.LEQUAL),this.properties={},this.properties.samples=256,this.properties.isovalue=0,this.properties.isowalls=!1,this.properties.isoalpha=.75,this.properties.isosmooth=1,this.properties.colour=[214,188,86],this.properties.xmin=this.properties.ymin=this.properties.zmin=0,this.properties.xmax=this.properties.ymax=this.properties.zmax=1,this.properties.density=10,this.properties.saturation=1,this.properties.brightness=0,this.properties.contrast=1,this.properties.power=1,this.properties.mindensity=t.volume.mindensity||0,this.properties.maxdensity=t.volume.mindensity||1,this.properties.usecolourmap=!1,this.properties.tricubicFilter=!1,this.properties.interactive=i,this.properties.axes=!0,this.properties.border=!0,this.load(t)}function initPage(){window.onresize=autoResize,info=new Popup("info"),info.show(),colourmaps=new Popup("colourmap",400,200);try{if(!window.WebGLRenderingContext)throw"No browser WebGL support";var t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)throw"No WebGL context available";t=e=null}catch(i){return void($("status").innerHTML="Sorry, ShareVol requires a <a href='http://get.webgl.org'>WebGL</a> capable browser!")}mobile=screen.width<=760||/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent),colours=new GradientEditor($("palette"),updateColourmap);var r=getSearchVariable("data");r||(r="default.json"),$("status").innerHTML="Loading params...",ajaxReadFile(decodeURI(r),loadData,!0),jsonfile=r}function loadStoredData(t){if(localStorage[t])try{var e=JSON.parse(localStorage[t]);state=e}catch(i){alert("parse error: "+i.message),localStorage[t]=null}}function loadData(t,e){var i=JSON.parse(t);i.volume?(state={},state.properties={},state.colourmaps=[{}],object={},view={},state.views=[view],state.objects=[object],object.name="volume",object.samples=i.volume.properties.samples,object.isovalue=i.volume.properties.isovalue,object.isowalls=i.volume.properties.drawWalls,object.isoalpha=i.volume.properties.isoalpha,object.isosmooth=i.volume.properties.isosmooth,object.colour=i.volume.properties.isocolour,object.density=i.volume.properties.density,object.power=i.volume.properties.power,i.volume.properties.usecolourmap&&(object.colourmap=0),object.tricubicfilter=i.volume.properties.tricubicFilter,object.zmin=i.volume.properties.Zmin,object.zmax=i.volume.properties.Zmax,object.ymin=i.volume.properties.Ymin,object.ymax=i.volume.properties.Ymax,object.xmin=i.volume.properties.Xmin,object.xmax=i.volume.properties.Xmax,object.brightness=i.volume.properties.brightness,object.contrast=i.volume.properties.contrast,object.volume={},object.volume.url=i.url,object.volume.res=i.res,object.volume.scale=i.scale,object.slices=i.slicer,state.properties.nogui=i.nogui,view.axes=i.volume.properties.axes,view.border=i.volume.properties.border,view.translate=i.volume.translate,view.rotate=i.volume.rotate,view.focus=i.volume.focus,colours.read(i.volume.colourmap),colours.update(),state.colourmaps=[colours.palette.get()],delete state.colourmaps[0].background,state.properties.background=colours.palette.background.html()):state=i,reset=state,getSearchVariable("reset")&&(localStorage.removeItem(e),console.log("Storage cleared")),state.objects[0].volume.res||(state.objects[0].volume.res=[256,256,256]),state.objects[0].volume.scale||(state.objects[0].volume.scale=[1,1,1]),loadTexture()}function saveData(){try{localStorage[filename]=getData()}catch(t){console.log("LocalStorage Error: Quota exceeded? "+t)}}function getData(t,e){if(volume){var i=volume.get(e),r=state.objects[0];r.saturation=i.properties.saturation,r.brightness=i.properties.brightness,r.contrast=i.properties.contrast,r.zmin=i.properties.zmin,r.zmax=i.properties.zmax,r.ymin=i.properties.ymin,r.ymax=i.properties.ymax,r.xmin=i.properties.xmin,r.xmax=i.properties.xmax,r.samples=i.properties.samples,r.isovalue=i.properties.isovalue,r.isowalls=i.properties.isowalls,r.isoalpha=i.properties.isoalpha,r.isosmooth=i.properties.isosmooth,r.colour=i.properties.colour,r.density=i.properties.density,r.power=i.properties.power,r.tricubicfilter=i.properties.tricubicFilter,i.properties.usecolourmap?r.colourmap=0:delete r.colourmap,state.views[0].axes=i.properties.axes,state.views[0].border=i.properties.border,state.views[0].translate=i.translate,state.views[0].rotate=i.rotate,slicer&&(state.objects[0].slices=slicer.get()),state.colourmaps=[colours.palette.get()],delete state.colourmaps[0].background,state.properties.background=colours.palette.background.html()}return console.log(JSON.stringify(state,null,2)),t?JSON.stringify(state):JSON.stringify(state,null,2)}function saveDataJson(){socket.emit("savedatajson",{file:jsonfile,json:getData()})}function hideMessage(){info.hide()}function exportData(){window.open("data:text/json;base64,"+window.btoa(getData()))}function resetFromData(t){t.objects[0].volume&&volume&&(volume.load(t.objects[0]),volume.draw()),t.objects[0].slices&&slicer&&(slicer.load(t.objects[0].slices),slicer.draw())}function loadTexture(){$("status").innerHTML="Loading image data... ";var t;loadImage(state.objects[0].volume.url,function(){t=new Image;var e=request.getAllResponseHeaders(),i=e.match(/^Content-Type\:\s*(.*?)$/im),r=i[1]||"image/png",o=new Blob([request.response],{type:r});t.src=window.URL.createObjectURL(o);document.createElement("img");t.onload=function(){console.log("Loaded image: "+t.width+" x "+t.height),imageLoaded(t)}})}function imageLoaded(t){if(state.objects[0].slices&&(mobile&&(state.objects[0].slices.show=!1),slicer=new Slicer(state.objects[0],t,"linear")),state.objects[0].volume&&(interactive=!0,(mobile||0==state.properties.interactive)&&(interactive=!1),volume=new Volume(state.objects[0],t,interactive),volume.slicer=slicer),document.addEventListener("mouseup",function(t){volume&&volume.delayedRender(250,!0)},!1),document.addEventListener("wheel",function(t){volume&&volume.delayedRender(250,!0)},!1),colours.read(state.colourmaps[0].colours),colours.palette.background=new Colour(state.properties.background),colours.update(),info.hide(),!state.properties.nogui){var e=new dat.GUI;state.properties.server&&e.add({Update:function(){ajaxPost(state.properties.server+"/update","data="+encodeURIComponent(getData(!0,!0)))}},"Update"),e.add({Restore:function(){resetFromData(state)}},"Restore"),e.add({Save:function(){saveDataJson()}},"Save"),e.add({ColourMaps:function(){window.colourmaps.toggle()}},"ColourMaps");var i=e.addFolder("Views"),r=1/Math.sqrt(2);i.add({XY:function(){volume.rotate=quat4.create([0,0,0,1])}},"XY"),i.add({YX:function(){volume.rotate=quat4.create([0,1,0,0])}},"YX"),i.add({XZ:function(){volume.rotate=quat4.create([r,0,0,-r])}},"XZ"),i.add({ZX:function(){volume.rotate=quat4.create([r,0,0,r])}},"ZX"),i.add({YZ:function(){volume.rotate=quat4.create([0,-r,0,-r])}},"YZ"),i.add({ZY:function(){volume.rotate=quat4.create([0,-r,0,r])}},"ZY"),volume&&volume.addGUI(e),slicer&&slicer.addGUI(e)}window.onbeforeunload=saveData}function autoResize(){volume&&(volume.width=0,volume.height=0,volume.draw())}function updateColourmap(){if(colours){var t=$("gradient");colours.palette.draw(t,!1),volume&&volume.webgl&&(volume.webgl.updateTexture(volume.webgl.gradientTexture,t,volume.gl.TEXTURE1),volume.applyBackground(colours.palette.background.html()),volume.draw()),slicer&&(slicer.updateColourmap(),slicer.draw())}}function loadImage(t,e){request=new XMLHttpRequest,request.onloadstart=showProgressBar,request.onprogress=updateProgressBar,request.onload=e,request.onloadend=hideProgressBar,request.open("GET",t,!0),request.responseType="arraybuffer",request.send(null)}function showProgressBar(){progressBar=document.createElement("progress"),progressBar.value=0,progressBar.max=100,progressBar.removeAttribute("value"),document.getElementById("status").appendChild(progressBar)}function updateProgressBar(t){t.lengthComputable?progressBar.value=t.loaded/t.total*100:progressBar.removeAttribute("value")}function hideProgressBar(){document.getElementById("status").removeChild(progressBar)}function Popup(t,e,i){this.el=$(t),this.style=$S(t),e&&i?(this.style.left=e+"px",this.style.top=i+"px"):(this.style.left=.5*(window.innerWidth-this.el.offsetWidth)+"px",this.style.top=.5*(window.innerHeight-this.el.offsetHeight)+"px"),this.drag=!1}var dat=dat||{};dat.gui=dat.gui||{},dat.utils=dat.utils||{},dat.controllers=dat.controllers||{},dat.dom=dat.dom||{},dat.color=dat.color||{},dat.utils.css=function(){return{load:function(t,e){e=e||document;var i=e.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=t,e.getElementsByTagName("head")[0].appendChild(i)},inject:function(t,e){e=e||document;var i=document.createElement("style");i.type="text/css",i.innerHTML=t,e.getElementsByTagName("head")[0].appendChild(i)}}}(),dat.utils.common=function(){var t=Array.prototype.forEach,e=Array.prototype.slice;return{BREAK:{},extend:function(t){return this.each(e.call(arguments,1),function(e){for(var i in e)this.isUndefined(e[i])||(t[i]=e[i])},this),t},defaults:function(t){return this.each(e.call(arguments,1),function(e){for(var i in e)this.isUndefined(t[i])&&(t[i]=e[i])},this),t},compose:function(){var t=e.call(arguments);return function(){for(var i=e.call(arguments),r=t.length-1;r>=0;r--)i=[t[r].apply(this,i)];return i[0]}},each:function(e,i,r){if(e)if(t&&e.forEach&&e.forEach===t)e.forEach(i,r);else if(e.length===e.length+0){for(var o=0,n=e.length;o<n;o++)if(o in e&&i.call(r,e[o],o)===this.BREAK)return}else for(var o in e)if(i.call(r,e[o],o)===this.BREAK)return},defer:function(t){setTimeout(t,0)},toArray:function(t){return t.toArray?t.toArray():e.call(t);
},isUndefined:function(t){return void 0===t},isNull:function(t){return null===t},isNaN:function(t){return t!==t},isArray:Array.isArray||function(t){return t.constructor===Array},isObject:function(t){return t===Object(t)},isNumber:function(t){return t===t+0},isString:function(t){return t===t+""},isBoolean:function(t){return t===!1||t===!0},isFunction:function(t){return"[object Function]"===Object.prototype.toString.call(t)}}}(),dat.controllers.Controller=function(t){var e=function(t,e){this.initialValue=t[e],this.domElement=document.createElement("div"),this.object=t,this.property=e,this.__onChange=void 0,this.__onFinishChange=void 0};return t.extend(e.prototype,{onChange:function(t){return this.__onChange=t,this},onFinishChange:function(t){return this.__onFinishChange=t,this},setValue:function(t){return this.object[this.property]=t,this.__onChange&&this.__onChange.call(this,t),this.updateDisplay(),this},getValue:function(){return this.object[this.property]},updateDisplay:function(){return this},isModified:function(){return this.initialValue!==this.getValue()}}),e}(dat.utils.common),dat.dom.dom=function(t){function e(e){if("0"===e||t.isUndefined(e))return 0;var i=e.match(o);return t.isNull(i)?0:parseFloat(i[1])}var i={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},r={};t.each(i,function(e,i){t.each(e,function(t){r[t]=i})});var o=/(\d+(\.\d+)?)px/,n={makeSelectable:function(t,e){void 0!==t&&void 0!==t.style&&(t.onselectstart=e?function(){return!1}:function(){},t.style.MozUserSelect=e?"auto":"none",t.style.KhtmlUserSelect=e?"auto":"none",t.unselectable=e?"on":"off")},makeFullscreen:function(e,i,r){t.isUndefined(i)&&(i=!0),t.isUndefined(r)&&(r=!0),e.style.position="absolute",i&&(e.style.left=0,e.style.right=0),r&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,i,o,n){o=o||{};var s=r[i];if(!s)throw new Error("Event type "+i+" not supported.");var a=document.createEvent(s);switch(s){case"MouseEvents":var l=o.x||o.clientX||0,h=o.y||o.clientY||0;a.initMouseEvent(i,o.bubbles||!1,o.cancelable||!0,window,o.clickCount||1,0,0,l,h,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var u=a.initKeyboardEvent||a.initKeyEvent;t.defaults(o,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),u(i,o.bubbles||!1,o.cancelable,window,o.ctrlKey,o.altKey,o.shiftKey,o.metaKey,o.keyCode,o.charCode);break;default:a.initEvent(i,o.bubbles||!1,o.cancelable||!0)}t.defaults(a,n),e.dispatchEvent(a)},bind:function(t,e,i,r){return r=r||!1,t.addEventListener?t.addEventListener(e,i,r):t.attachEvent&&t.attachEvent("on"+e,i),n},unbind:function(t,e,i,r){return r=r||!1,t.removeEventListener?t.removeEventListener(e,i,r):t.detachEvent&&t.detachEvent("on"+e,i),n},addClass:function(t,e){if(void 0===t.className)t.className=e;else if(t.className!==e){var i=t.className.split(/ +/);i.indexOf(e)==-1&&(i.push(e),t.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return n},removeClass:function(t,e){if(e)if(void 0===t.className);else if(t.className===e)t.removeAttribute("class");else{var i=t.className.split(/ +/),r=i.indexOf(e);r!=-1&&(i.splice(r,1),t.className=i.join(" "))}else t.className=void 0;return n},hasClass:function(t,e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(t.className)||!1},getWidth:function(t){var i=getComputedStyle(t);return e(i["border-left-width"])+e(i["border-right-width"])+e(i["padding-left"])+e(i["padding-right"])+e(i.width)},getHeight:function(t){var i=getComputedStyle(t);return e(i["border-top-width"])+e(i["border-bottom-width"])+e(i["padding-top"])+e(i["padding-bottom"])+e(i.height)},getOffset:function(t){var e={left:0,top:0};if(t.offsetParent)do e.left+=t.offsetLeft,e.top+=t.offsetTop;while(t=t.offsetParent);return e},isActive:function(t){return t===document.activeElement&&(t.type||t.href)}};return n}(dat.utils.common),dat.controllers.OptionController=function(t,e,i){var r=function(t,o,n){r.superclass.call(this,t,o);var s=this;if(this.__select=document.createElement("select"),i.isArray(n)){var a={};i.each(n,function(t){a[t]=t}),n=a}i.each(n,function(t,e){var i=document.createElement("option");i.innerHTML=e,i.setAttribute("value",t),s.__select.appendChild(i)}),this.updateDisplay(),e.bind(this.__select,"change",function(){var t=this.options[this.selectedIndex].value;s.setValue(t)}),this.domElement.appendChild(this.__select)};return r.superclass=t,i.extend(r.prototype,t.prototype,{setValue:function(t){var e=r.superclass.prototype.setValue.call(this,t);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),e},updateDisplay:function(){return this.__select.value=this.getValue(),r.superclass.prototype.updateDisplay.call(this)}}),r}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.NumberController=function(t,e){function i(t){return t=t.toString(),t.indexOf(".")>-1?t.length-t.indexOf(".")-1:0}var r=function(t,o,n){r.superclass.call(this,t,o),n=n||{},this.__min=n.min,this.__max=n.max,this.__step=n.step,e.isUndefined(this.__step)?0==this.initialValue?this.__impliedStep=1:this.__impliedStep=Math.pow(10,Math.floor(Math.log(this.initialValue)/Math.LN10))/10:this.__impliedStep=this.__step,this.__precision=i(this.__impliedStep)};return r.superclass=t,e.extend(r.prototype,t.prototype,{setValue:function(t){return void 0!==this.__min&&t<this.__min?t=this.__min:void 0!==this.__max&&t>this.__max&&(t=this.__max),void 0!==this.__step&&t%this.__step!=0&&(t=Math.round(t/this.__step)*this.__step),r.superclass.prototype.setValue.call(this,t)},min:function(t){return this.__min=t,this},max:function(t){return this.__max=t,this},step:function(t){return this.__step=t,this.__impliedStep=t,this.__precision=i(t),this}}),r}(dat.controllers.Controller,dat.utils.common),dat.controllers.NumberControllerBox=function(t,e,i){function r(t,e){var i=Math.pow(10,e);return Math.round(t*i)/i}var o=function(t,r,n){function s(){var t=parseFloat(c.__input.value);i.isNaN(t)||c.setValue(t)}function a(){s(),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}function l(t){e.bind(window,"mousemove",h),e.bind(window,"mouseup",u),d=t.clientY}function h(t){var e=d-t.clientY;c.setValue(c.getValue()+e*c.__impliedStep),d=t.clientY}function u(){e.unbind(window,"mousemove",h),e.unbind(window,"mouseup",u)}this.__truncationSuspended=!1,o.superclass.call(this,t,r,n);var d,c=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),e.bind(this.__input,"change",s),e.bind(this.__input,"blur",a),e.bind(this.__input,"mousedown",l),e.bind(this.__input,"keydown",function(t){13===t.keyCode&&(c.__truncationSuspended=!0,this.blur(),c.__truncationSuspended=!1)}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return o.superclass=t,i.extend(o.prototype,t.prototype,{updateDisplay:function(){return this.__input.value=this.__truncationSuspended?this.getValue():r(this.getValue(),this.__precision),o.superclass.prototype.updateDisplay.call(this)}}),o}(dat.controllers.NumberController,dat.dom.dom,dat.utils.common),dat.controllers.NumberControllerSlider=function(t,e,i,r,o){function n(t,e,i,r,o){return r+(o-r)*((t-e)/(i-e))}var s=function(t,i,r,o,a){function l(t){e.bind(window,"mousemove",h),e.bind(window,"mouseup",u),h(t)}function h(t){t.preventDefault();var i=e.getOffset(d.__background),r=e.getWidth(d.__background);return d.setValue(n(t.clientX,i.left,i.left+r,d.__min,d.__max)),!1}function u(){e.unbind(window,"mousemove",h),e.unbind(window,"mouseup",u),d.__onFinishChange&&d.__onFinishChange.call(d,d.getValue())}s.superclass.call(this,t,i,{min:r,max:o,step:a});var d=this;this.__background=document.createElement("div"),this.__foreground=document.createElement("div"),e.bind(this.__background,"mousedown",l),e.addClass(this.__background,"slider"),e.addClass(this.__foreground,"slider-fg"),this.updateDisplay(),this.__background.appendChild(this.__foreground),this.domElement.appendChild(this.__background)};return s.superclass=t,s.useDefaultStyles=function(){i.inject(o)},r.extend(s.prototype,t.prototype,{updateDisplay:function(){var t=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*t+"%",s.superclass.prototype.updateDisplay.call(this)}}),s}(dat.controllers.NumberController,dat.dom.dom,dat.utils.css,dat.utils.common,"/**\n * dat-gui JavaScript Controller Library\n * http://code.google.com/p/dat-gui\n *\n * Copyright 2011 Data Arts Team, Google Creative Lab\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n */\n\n.slider {\n  box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);\n  height: 1em;\n  border-radius: 1em;\n  background-color: #eee;\n  padding: 0 0.5em;\n  overflow: hidden;\n}\n\n.slider-fg {\n  padding: 1px 0 2px 0;\n  background-color: #aaa;\n  height: 1em;\n  margin-left: -0.5em;\n  padding-right: 0.5em;\n  border-radius: 1em 0 0 1em;\n}\n\n.slider-fg:after {\n  display: inline-block;\n  border-radius: 1em;\n  background-color: #fff;\n  border:  1px solid #aaa;\n  content: '';\n  float: right;\n  margin-right: -1em;\n  margin-top: -1px;\n  height: 0.9em;\n  width: 0.9em;\n}"),dat.controllers.FunctionController=function(t,e,i){var r=function(t,i,o){r.superclass.call(this,t,i);var n=this;this.__button=document.createElement("div"),this.__button.innerHTML=void 0===o?"Fire":o,e.bind(this.__button,"click",function(t){return t.preventDefault(),n.fire(),!1}),e.addClass(this.__button,"button"),this.domElement.appendChild(this.__button)};return r.superclass=t,i.extend(r.prototype,t.prototype,{fire:function(){this.__onChange&&this.__onChange.call(this),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.getValue().call(this.object)}}),r}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.BooleanController=function(t,e,i){var r=function(t,i){function o(){n.setValue(!n.__prev)}r.superclass.call(this,t,i);var n=this;this.__prev=this.getValue(),this.__checkbox=document.createElement("input"),this.__checkbox.setAttribute("type","checkbox"),e.bind(this.__checkbox,"change",o,!1),this.domElement.appendChild(this.__checkbox),this.updateDisplay()};return r.superclass=t,i.extend(r.prototype,t.prototype,{setValue:function(t){var e=r.superclass.prototype.setValue.call(this,t);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),e},updateDisplay:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0):this.__checkbox.checked=!1,r.superclass.prototype.updateDisplay.call(this)}}),r}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.color.toString=function(t){return function(e){if(1==e.a||t.isUndefined(e.a)){for(var i=e.hex.toString(16);i.length<6;)i="0"+i;return"#"+i}return"rgba("+Math.round(e.r)+","+Math.round(e.g)+","+Math.round(e.b)+","+e.a+")"}}(dat.utils.common),dat.color.interpret=function(t,e){var i,r,o=function(){r=!1;var t=arguments.length>1?e.toArray(arguments):arguments[0];return e.each(n,function(o){if(o.litmus(t))return e.each(o.conversions,function(o,n){if(i=o.read(t),r===!1&&i!==!1)return r=i,i.conversionName=n,i.conversion=o,e.BREAK}),e.BREAK}),r},n=[{litmus:e.isString,conversions:{THREE_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString())}},write:t},SIX_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9]{6})$/i);return null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString())}},write:t},CSS_RGB:{read:function(t){var e=t.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:t},CSS_RGBA:{read:function(t){var e=t.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/);return null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:t}}},{litmus:e.isNumber,conversions:{HEX:{read:function(t){return{space:"HEX",hex:t,conversionName:"HEX"}},write:function(t){return t.hex}}}},{litmus:e.isArray,conversions:{RGB_ARRAY:{read:function(t){return 3==t.length&&{space:"RGB",r:t[0],g:t[1],b:t[2]}},write:function(t){return[t.r,t.g,t.b]}},RGBA_ARRAY:{read:function(t){return 4==t.length&&{space:"RGB",r:t[0],g:t[1],b:t[2],a:t[3]}},write:function(t){return[t.r,t.g,t.b,t.a]}}}},{litmus:e.isObject,conversions:{RGBA_OBJ:{read:function(t){return!!(e.isNumber(t.r)&&e.isNumber(t.g)&&e.isNumber(t.b)&&e.isNumber(t.a))&&{space:"RGB",r:t.r,g:t.g,b:t.b,a:t.a}},write:function(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}},RGB_OBJ:{read:function(t){return!!(e.isNumber(t.r)&&e.isNumber(t.g)&&e.isNumber(t.b))&&{space:"RGB",r:t.r,g:t.g,b:t.b}},write:function(t){return{r:t.r,g:t.g,b:t.b}}},HSVA_OBJ:{read:function(t){return!!(e.isNumber(t.h)&&e.isNumber(t.s)&&e.isNumber(t.v)&&e.isNumber(t.a))&&{space:"HSV",h:t.h,s:t.s,v:t.v,a:t.a}},write:function(t){return{h:t.h,s:t.s,v:t.v,a:t.a}}},HSV_OBJ:{read:function(t){return!!(e.isNumber(t.h)&&e.isNumber(t.s)&&e.isNumber(t.v))&&{space:"HSV",h:t.h,s:t.s,v:t.v}},write:function(t){return{h:t.h,s:t.s,v:t.v}}}}}];return o}(dat.color.toString,dat.utils.common),dat.GUI=dat.gui.GUI=function(t,e,i,r,o,n,s,a,l,h,u,d,c,p,f){function g(t,e,i,n){if(void 0===e[i])throw new Error("Object "+e+' has no property "'+i+'"');var s;if(n.color)s=new u(e,i);else{var a=[e,i].concat(n.factoryArgs);s=r.apply(t,a)}n.before instanceof o&&(n.before=n.before.__li),b(t,s),p.addClass(s.domElement,"c");var l=document.createElement("span");p.addClass(l,"property-name"),l.innerHTML=s.property;var h=document.createElement("div");h.appendChild(l),h.appendChild(s.domElement);var d=m(t,h,n.before);return p.addClass(d,O.CLASS_CONTROLLER_ROW),p.addClass(d,typeof s.getValue()),v(t,d,s),t.__controllers.push(s),s}function m(t,e,i){var r=document.createElement("li");return e&&r.appendChild(e),i?t.__ul.insertBefore(r,params.before):t.__ul.appendChild(r),t.onResize(),r}function v(t,e,i){if(i.__li=e,i.__gui=t,f.extend(i,{options:function(e){return arguments.length>1?(i.remove(),g(t,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[f.toArray(arguments)]})):f.isArray(e)||f.isObject(e)?(i.remove(),g(t,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[e]})):void 0},name:function(t){return i.__li.firstElementChild.firstElementChild.innerHTML=t,i},listen:function(){return i.__gui.listen(i),i},remove:function(){return i.__gui.remove(i),i}}),i instanceof l){var r=new a(i.object,i.property,{min:i.__min,max:i.__max,step:i.__step});f.each(["updateDisplay","onChange","onFinishChange"],function(t){var e=i[t],o=r[t];i[t]=r[t]=function(){var t=Array.prototype.slice.call(arguments);return e.apply(i,t),o.apply(r,t)}}),p.addClass(e,"has-slider"),i.domElement.insertBefore(r.domElement,i.domElement.firstElementChild)}else if(i instanceof a){var o=function(e){return f.isNumber(i.__min)&&f.isNumber(i.__max)?(i.remove(),g(t,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[i.__min,i.__max,i.__step]})):e};i.min=f.compose(o,i.min),i.max=f.compose(o,i.max)}else i instanceof n?(p.bind(e,"click",function(){p.fakeEvent(i.__checkbox,"click")}),p.bind(i.__checkbox,"click",function(t){t.stopPropagation()})):i instanceof s?(p.bind(e,"click",function(){p.fakeEvent(i.__button,"click")}),p.bind(e,"mouseover",function(){p.addClass(i.__button,"hover")}),p.bind(e,"mouseout",function(){p.removeClass(i.__button,"hover")})):i instanceof u&&(p.addClass(e,"color"),i.updateDisplay=f.compose(function(t){return e.style.borderLeftColor=i.__color.toString(),t},i.updateDisplay),i.updateDisplay());i.setValue=f.compose(function(e){return t.getRoot().__preset_select&&i.isModified()&&S(t.getRoot(),!0),e},i.setValue)}function b(t,e){var i=t.getRoot(),r=i.__rememberedObjects.indexOf(e.object);if(r!=-1){var o=i.__rememberedObjectIndecesToControllers[r];if(void 0===o&&(o={},i.__rememberedObjectIndecesToControllers[r]=o),o[e.property]=e,i.load&&i.load.remembered){var n,s=i.load.remembered;if(s[t.preset])n=s[t.preset];else{if(!s[L])return;n=s[L]}if(n[r]&&void 0!==n[r][e.property]){var a=n[r][e.property];e.initialValue=a,e.setValue(a)}}}}function _(t,e){return document.location.href+"."+e}function w(t){function e(){h.style.display=t.useLocalStorage?"block":"none"}var i=t.__save_row=document.createElement("li");p.addClass(t.domElement,"has-save"),t.__ul.insertBefore(i,t.__ul.firstChild),p.addClass(i,"save-row");var r=document.createElement("span");r.innerHTML="&nbsp;",p.addClass(r,"button gears");var o=document.createElement("span");o.innerHTML="Save",p.addClass(o,"button"),p.addClass(o,"save");var n=document.createElement("span");n.innerHTML="New",p.addClass(n,"button"),p.addClass(n,"save-as");var s=document.createElement("span");s.innerHTML="Revert",p.addClass(s,"button"),p.addClass(s,"revert");var a=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?f.each(t.load.remembered,function(e,i){E(t,i,i==t.preset)}):E(t,L,!1),p.bind(a,"change",function(){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].innerHTML=t.__preset_select[e].value;t.preset=this.value}),i.appendChild(a),i.appendChild(r),i.appendChild(o),i.appendChild(n),i.appendChild(s),F){var l=document.getElementById("dg-save-locally"),h=document.getElementById("dg-local-explain");l.style.display="block";var u=document.getElementById("dg-local-storage");"true"===localStorage.getItem(_(t,"isLocal"))&&u.setAttribute("checked","checked"),e(),p.bind(u,"change",function(){t.useLocalStorage=!t.useLocalStorage,e()})}var d=document.getElementById("dg-new-constructor");p.bind(d,"keydown",function(t){!t.metaKey||67!==t.which&&67!=t.keyCode||k.hide()}),p.bind(r,"click",function(){d.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),k.show(),d.focus(),d.select()}),p.bind(o,"click",function(){t.save()}),p.bind(n,"click",function(){var e=prompt("Enter a new preset name.");e&&t.saveAs(e)}),p.bind(s,"click",function(){t.revert()})}function y(t){function e(e){return e.preventDefault(),o=e.clientX,p.addClass(t.__closeButton,O.CLASS_DRAG),p.bind(window,"mousemove",i),p.bind(window,"mouseup",r),!1}function i(e){return e.preventDefault(),t.width+=o-e.clientX,t.onResize(),o=e.clientX,!1}function r(){p.removeClass(t.__closeButton,O.CLASS_DRAG),p.unbind(window,"mousemove",i),p.unbind(window,"mouseup",r)}t.__resize_handle=document.createElement("div"),f.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});var o;p.bind(t.__resize_handle,"mousedown",e),p.bind(t.__closeButton,"mousedown",e),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}function x(t,e){t.domElement.style.width=e+"px",t.__save_row&&t.autoPlace&&(t.__save_row.style.width=e+"px"),t.__closeButton&&(t.__closeButton.style.width=e+"px")}function A(t,e){var i={};return f.each(t.__rememberedObjects,function(r,o){var n={},s=t.__rememberedObjectIndecesToControllers[o];f.each(s,function(t,i){n[i]=e?t.initialValue:t.getValue()}),i[o]=n}),i}function E(t,e,i){var r=document.createElement("option");r.innerHTML=e,r.value=e,t.__preset_select.appendChild(r),i&&(t.__preset_select.selectedIndex=t.__preset_select.length-1)}function C(t){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].value==t.preset&&(t.__preset_select.selectedIndex=e)}function S(t,e){var i=t.__preset_select[t.__preset_select.selectedIndex];e?i.innerHTML=i.value+"*":i.innerHTML=i.value}function M(t){0!=t.length&&d(function(){M(t)}),f.each(t,function(t){t.updateDisplay()})}t.inject(i);var k,T,R="dg",B=72,P=20,L="Default",F=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(t){return!1}}(),V=!0,I=!1,D=[],O=function(t){function e(){var t=i.getRoot();t.width+=1,f.defer(function(){t.width-=1})}var i=this;this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),p.addClass(this.domElement,R),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],t=t||{},t=f.defaults(t,{autoPlace:!0,width:O.DEFAULT_WIDTH}),t=f.defaults(t,{resizable:t.autoPlace,hideable:t.autoPlace}),f.isUndefined(t.load)?t.load={preset:L}:t.preset&&(t.load.preset=t.preset),f.isUndefined(t.parent)&&t.hideable&&D.push(this),t.resizable=f.isUndefined(t.parent)&&t.resizable,t.autoPlace&&f.isUndefined(t.scrollable)&&(t.scrollable=!0);var r,o=F&&"true"===localStorage.getItem(_(this,"isLocal"));if(Object.defineProperties(this,{parent:{get:function(){return t.parent}},scrollable:{get:function(){return t.scrollable}},autoPlace:{get:function(){return t.autoPlace}},preset:{get:function(){return i.parent?i.getRoot().preset:t.load.preset},set:function(e){i.parent?i.getRoot().preset=e:t.load.preset=e,C(this),i.revert()}},width:{get:function(){return t.width},set:function(e){t.width=e,x(i,e)}},name:{get:function(){return t.name},set:function(e){t.name=e,s&&(s.innerHTML=t.name)}},closed:{get:function(){return t.closed},set:function(e){t.closed=e,t.closed?p.addClass(i.__ul,O.CLASS_CLOSED):p.removeClass(i.__ul,O.CLASS_CLOSED),this.onResize(),i.__closeButton&&(i.__closeButton.innerHTML=e?O.TEXT_OPEN:O.TEXT_CLOSED)}},load:{get:function(){return t.load}},useLocalStorage:{get:function(){return o},set:function(t){F&&(o=t,t?p.bind(window,"unload",r):p.unbind(window,"unload",r),localStorage.setItem(_(i,"isLocal"),t))}}}),f.isUndefined(t.parent)){if(t.closed=!1,p.addClass(this.domElement,O.CLASS_MAIN),p.makeSelectable(this.domElement,!1),F&&o){i.useLocalStorage=!0;var n=localStorage.getItem(_(this,"gui"));n&&(t.load=JSON.parse(n))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=O.TEXT_CLOSED,p.addClass(this.__closeButton,O.CLASS_CLOSE_BUTTON),this.domElement.appendChild(this.__closeButton),p.bind(this.__closeButton,"click",function(){i.closed=!i.closed})}else{void 0===t.closed&&(t.closed=!0);var s=document.createTextNode(t.name);p.addClass(s,"controller-name");var a=m(i,s),l=function(t){return t.preventDefault(),i.closed=!i.closed,!1};p.addClass(this.__ul,O.CLASS_CLOSED),p.addClass(a,"title"),p.bind(a,"click",l),t.closed||(this.closed=!1)}t.autoPlace&&(f.isUndefined(t.parent)&&(V&&(T=document.createElement("div"),p.addClass(T,R),p.addClass(T,O.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(T),V=!1),T.appendChild(this.domElement),p.addClass(this.domElement,O.CLASS_AUTO_PLACE)),this.parent||x(i,t.width)),p.bind(window,"resize",function(){i.onResize()}),p.bind(this.__ul,"webkitTransitionEnd",function(){i.onResize()}),p.bind(this.__ul,"transitionend",function(){i.onResize()}),p.bind(this.__ul,"oTransitionEnd",function(){i.onResize()}),this.onResize(),t.resizable&&y(this),r=function(){F&&"true"===localStorage.getItem(_(i,"isLocal"))&&localStorage.setItem(_(i,"gui"),JSON.stringify(i.getSaveObject()))},this.saveToLocalStorageIfPossible=r;i.getRoot();t.parent||e()};return O.toggleHide=function(){I=!I,f.each(D,function(t){t.domElement.style.zIndex=I?-999:999,t.domElement.style.opacity=I?0:1})},O.CLASS_AUTO_PLACE="a",O.CLASS_AUTO_PLACE_CONTAINER="ac",O.CLASS_MAIN="main",O.CLASS_CONTROLLER_ROW="cr",O.CLASS_TOO_TALL="taller-than-window",O.CLASS_CLOSED="closed",O.CLASS_CLOSE_BUTTON="close-button",O.CLASS_DRAG="drag",O.DEFAULT_WIDTH=245,O.TEXT_CLOSED="Close Controls",O.TEXT_OPEN="Open Controls",p.bind(window,"keydown",function(t){"text"===document.activeElement.type||t.which!==B&&t.keyCode!=B||O.toggleHide()},!1),f.extend(O.prototype,{add:function(t,e){return g(this,t,e,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(t,e){return g(this,t,e,{color:!0})},remove:function(t){this.__ul.removeChild(t.__li),this.__controllers.slice(this.__controllers.indexOf(t),1);var e=this;f.defer(function(){e.onResize()})},destroy:function(){this.autoPlace&&T.removeChild(this.domElement)},addFolder:function(t){if(void 0!==this.__folders[t])throw new Error('You already have a folder in this GUI by the name "'+t+'"');var e={name:t,parent:this};e.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[t]&&(e.closed=this.load.folders[t].closed,e.load=this.load.folders[t]);var i=new O(e);this.__folders[t]=i;var r=m(this,i.domElement);return p.addClass(r,"folder"),i},open:function(){this.closed=!1},close:function(){this.closed=!0},onResize:function(){var t=this.getRoot();if(t.scrollable){var e=p.getOffset(t.__ul).top,i=0;f.each(t.__ul.childNodes,function(e){t.autoPlace&&e===t.__save_row||(i+=p.getHeight(e))}),window.innerHeight-e-P<i?(p.addClass(t.domElement,O.CLASS_TOO_TALL),t.__ul.style.height=window.innerHeight-e-P+"px"):(p.removeClass(t.domElement,O.CLASS_TOO_TALL),t.__ul.style.height="auto")}t.__resize_handle&&f.defer(function(){t.__resize_handle.style.height=t.__ul.offsetHeight+"px"}),t.__closeButton&&(t.__closeButton.style.width=t.width+"px")},remember:function(){if(f.isUndefined(k)&&(k=new c,k.domElement.innerHTML=e),this.parent)throw new Error("You can only call remember on a top level GUI.");var t=this;f.each(Array.prototype.slice.call(arguments),function(e){0==t.__rememberedObjects.length&&w(t),t.__rememberedObjects.indexOf(e)==-1&&t.__rememberedObjects.push(e)}),this.autoPlace&&x(this,this.width)},getRoot:function(){for(var t=this;t.parent;)t=t.parent;return t},getSaveObject:function(){var t=this.load;return t.closed=this.closed,this.__rememberedObjects.length>0&&(t.preset=this.preset,t.remembered||(t.remembered={}),t.remembered[this.preset]=A(this)),t.folders={},f.each(this.__folders,function(e,i){t.folders[i]=e.getSaveObject()}),t},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=A(this),S(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(t){this.load.remembered||(this.load.remembered={},this.load.remembered[L]=A(this,!0)),this.load.remembered[t]=A(this),this.preset=t,E(this,t,!0),this.saveToLocalStorageIfPossible()},revert:function(t){f.each(this.__controllers,function(e){this.getRoot().load.remembered?b(t||this.getRoot(),e):e.setValue(e.initialValue)},this),f.each(this.__folders,function(t){t.revert(t)}),t||S(this.getRoot(),!1)},listen:function(t){var e=0==this.__listening.length;this.__listening.push(t),e&&M(this.__listening)}}),O}(dat.utils.css,'<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n      \n    </div>\n    \n  </div>\n\n</div>',".dg {\n  /** Clear list styles */\n  /* Auto-place container */\n  /* Auto-placed GUI's */\n  /* Line items that don't contain folders. */\n  /** Folder names */\n  /** Hides closed items */\n  /** Controller row */\n  /** Name-half (left) */\n  /** Controller-half (right) */\n  /** Controller placement */\n  /** Shorter number boxes when slider is present. */\n  /** Ensure the entire boolean and function row shows a hand */ }\n  .dg ul {\n    list-style: none;\n    margin: 0;\n    padding: 0;\n    width: 100%;\n    clear: both; }\n  .dg.ac {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 0;\n    z-index: 0; }\n  .dg:not(.ac) .main {\n    /** Exclude mains in ac so that we don't hide close button */\n    overflow: hidden; }\n  .dg.main {\n    -webkit-transition: opacity 0.1s linear;\n    -o-transition: opacity 0.1s linear;\n    -moz-transition: opacity 0.1s linear;\n    transition: opacity 0.1s linear; }\n    .dg.main.taller-than-window {\n      overflow-y: auto; }\n      .dg.main.taller-than-window .close-button {\n        opacity: 1;\n        /* TODO, these are style notes */\n        margin-top: -1px;\n        border-top: 1px solid #2c2c2c; }\n    .dg.main ul.closed .close-button {\n      opacity: 1 !important; }\n    .dg.main:hover .close-button,\n    .dg.main .close-button.drag {\n      opacity: 1; }\n    .dg.main .close-button {\n      /*opacity: 0;*/\n      -webkit-transition: opacity 0.1s linear;\n      -o-transition: opacity 0.1s linear;\n      -moz-transition: opacity 0.1s linear;\n      transition: opacity 0.1s linear;\n      border: 0;\n      position: absolute;\n      line-height: 19px;\n      height: 20px;\n      /* TODO, these are style notes */\n      cursor: pointer;\n      text-align: center;\n      background-color: #000; }\n      .dg.main .close-button:hover {\n        background-color: #111; }\n  .dg.a {\n    float: right;\n    margin-right: 15px;\n    overflow-x: hidden; }\n    .dg.a.has-save > ul {\n      margin-top: 27px; }\n      .dg.a.has-save > ul.closed {\n        margin-top: 0; }\n    .dg.a .save-row {\n      position: fixed;\n      top: 0;\n      z-index: 1002; }\n  .dg li {\n    -webkit-transition: height 0.1s ease-out;\n    -o-transition: height 0.1s ease-out;\n    -moz-transition: height 0.1s ease-out;\n    transition: height 0.1s ease-out; }\n  .dg li:not(.folder) {\n    cursor: auto;\n    height: 27px;\n    line-height: 27px;\n    overflow: hidden;\n    padding: 0 4px 0 5px; }\n  .dg li.folder {\n    padding: 0;\n    border-left: 4px solid rgba(0, 0, 0, 0); }\n  .dg li.title {\n    cursor: pointer;\n    margin-left: -4px; }\n  .dg .closed li:not(.title),\n  .dg .closed ul li,\n  .dg .closed ul li > * {\n    height: 0;\n    overflow: hidden;\n    border: 0; }\n  .dg .cr {\n    clear: both;\n    padding-left: 3px;\n    height: 27px; }\n  .dg .property-name {\n    cursor: default;\n    float: left;\n    clear: left;\n    width: 40%;\n    overflow: hidden;\n    text-overflow: ellipsis; }\n  .dg .c {\n    float: left;\n    width: 60%; }\n  .dg .c input[type=text] {\n    border: 0;\n    margin-top: 4px;\n    padding: 3px;\n    width: 100%;\n    float: right; }\n  .dg .has-slider input[type=text] {\n    width: 30%;\n    /*display: none;*/\n    margin-left: 0; }\n  .dg .slider {\n    float: left;\n    width: 66%;\n    margin-left: -5px;\n    margin-right: 0;\n    height: 19px;\n    margin-top: 4px; }\n  .dg .slider-fg {\n    height: 100%; }\n  .dg .c input[type=checkbox] {\n    margin-top: 9px; }\n  .dg .c select {\n    margin-top: 5px; }\n  .dg .cr.function,\n  .dg .cr.function .property-name,\n  .dg .cr.function *,\n  .dg .cr.boolean,\n  .dg .cr.boolean * {\n    cursor: pointer; }\n  .dg .selector {\n    display: none;\n    position: absolute;\n    margin-left: -9px;\n    margin-top: 23px;\n    z-index: 10; }\n  .dg .c:hover .selector,\n  .dg .selector.drag {\n    display: block; }\n  .dg li.save-row {\n    padding: 0; }\n    .dg li.save-row .button {\n      display: inline-block;\n      padding: 0px 6px; }\n  .dg.dialogue {\n    background-color: #222;\n    width: 460px;\n    padding: 15px;\n    font-size: 13px;\n    line-height: 15px; }\n\n/* TODO Separate style and structure */\n#dg-new-constructor {\n  padding: 10px;\n  color: #222;\n  font-family: Monaco, monospace;\n  font-size: 10px;\n  border: 0;\n  resize: none;\n  box-shadow: inset 1px 1px 1px #888;\n  word-wrap: break-word;\n  margin: 12px 0;\n  display: block;\n  width: 440px;\n  overflow-y: scroll;\n  height: 100px;\n  position: relative; }\n\n#dg-local-explain {\n  display: none;\n  font-size: 11px;\n  line-height: 17px;\n  border-radius: 3px;\n  background-color: #333;\n  padding: 8px;\n  margin-top: 10px; }\n  #dg-local-explain code {\n    font-size: 10px; }\n\n#dat-gui-save-locally {\n  display: none; }\n\n/** Main type */\n.dg {\n  color: #eee;\n  font: 11px 'Lucida Grande', sans-serif;\n  text-shadow: 0 -1px 0 #111;\n  /** Auto place */\n  /* Controller row, <li> */\n  /** Controllers */ }\n  .dg.main {\n    /** Scrollbar */ }\n    .dg.main::-webkit-scrollbar {\n      width: 5px;\n      background: #1a1a1a; }\n    .dg.main::-webkit-scrollbar-corner {\n      height: 0;\n      display: none; }\n    .dg.main::-webkit-scrollbar-thumb {\n      border-radius: 5px;\n      background: #676767; }\n  .dg li:not(.folder) {\n    background: #1a1a1a;\n    border-bottom: 1px solid #2c2c2c; }\n  .dg li.save-row {\n    line-height: 25px;\n    background: #dad5cb;\n    border: 0; }\n    .dg li.save-row select {\n      margin-left: 5px;\n      width: 108px; }\n    .dg li.save-row .button {\n      margin-left: 5px;\n      margin-top: 1px;\n      border-radius: 2px;\n      font-size: 9px;\n      line-height: 7px;\n      padding: 4px 4px 5px 4px;\n      background: #c5bdad;\n      color: #fff;\n      text-shadow: 0 1px 0 #b0a58f;\n      box-shadow: 0 -1px 0 #b0a58f;\n      cursor: pointer; }\n      .dg li.save-row .button.gears {\n        background: #c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;\n        height: 7px;\n        width: 8px; }\n      .dg li.save-row .button:hover {\n        background-color: #bab19e;\n        box-shadow: 0 -1px 0 #b0a58f; }\n  .dg li.folder {\n    border-bottom: 0; }\n  .dg li.title {\n    padding-left: 16px;\n    background: black url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;\n    cursor: pointer;\n    border-bottom: 1px solid rgba(255, 255, 255, 0.2); }\n  .dg .closed li.title {\n    background-image: url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==); }\n  .dg .cr.boolean {\n    border-left: 3px solid #806787; }\n  .dg .cr.function {\n    border-left: 3px solid #e61d5f; }\n  .dg .cr.number {\n    border-left: 3px solid #2fa1d6; }\n    .dg .cr.number input[type=text] {\n      color: #2fa1d6; }\n  .dg .cr.string {\n    border-left: 3px solid #1ed36f; }\n    .dg .cr.string input[type=text] {\n      color: #1ed36f; }\n  .dg .cr.function:hover, .dg .cr.boolean:hover {\n    background: #111; }\n  .dg .c input[type=text] {\n    background: #303030;\n    outline: none; }\n    .dg .c input[type=text]:hover {\n      background: #3c3c3c; }\n    .dg .c input[type=text]:focus {\n      background: #494949;\n      color: #fff; }\n  .dg .c .slider {\n    background: #303030;\n    cursor: ew-resize; }\n  .dg .c .slider-fg {\n    background: #2fa1d6; }\n  .dg .c .slider:hover {\n    background: #3c3c3c; }\n    .dg .c .slider:hover .slider-fg {\n      background: #44abda; }\n",dat.controllers.factory=function(t,e,i,r,o,n,s){
return function(a,l){var h=a[l];return s.isArray(arguments[2])||s.isObject(arguments[2])?new t(a,l,arguments[2]):s.isNumber(h)?s.isNumber(arguments[2])&&s.isNumber(arguments[3])?new i(a,l,arguments[2],arguments[3]):new e(a,l,{min:arguments[2],max:arguments[3]}):s.isString(h)?new r(a,l):s.isFunction(h)?new o(a,l,""):s.isBoolean(h)?new n(a,l):void 0}}(dat.controllers.OptionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.StringController=function(t,e,i){var r=function(t,i){function o(){s.setValue(s.__input.value)}function n(){s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}r.superclass.call(this,t,i);var s=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),e.bind(this.__input,"keyup",o),e.bind(this.__input,"change",o),e.bind(this.__input,"blur",n),e.bind(this.__input,"keydown",function(t){13===t.keyCode&&this.blur()}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return r.superclass=t,i.extend(r.prototype,t.prototype,{updateDisplay:function(){return e.isActive(this.__input)||(this.__input.value=this.getValue()),r.superclass.prototype.updateDisplay.call(this)}}),r}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.FunctionController,dat.controllers.BooleanController,dat.utils.common),dat.controllers.Controller,dat.controllers.BooleanController,dat.controllers.FunctionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.OptionController,dat.controllers.ColorController=function(t,e,i,r,o){function n(t,e,i,r){t.style.background="",o.each(l,function(o){t.style.cssText+="background: "+o+"linear-gradient("+e+", "+i+" 0%, "+r+" 100%); "})}function s(t){t.style.background="",t.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",t.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var a=function(t,l){function h(t){p(t),e.bind(window,"mousemove",p),e.bind(window,"mouseup",u)}function u(){e.unbind(window,"mousemove",p),e.unbind(window,"mouseup",u)}function d(){var t=r(this.value);t!==!1?(g.__color.__state=t,g.setValue(g.__color.toOriginal())):this.value=g.__color.toString()}function c(){e.unbind(window,"mousemove",f),e.unbind(window,"mouseup",c)}function p(t){t.preventDefault();var i=e.getWidth(g.__saturation_field),r=e.getOffset(g.__saturation_field),o=(t.clientX-r.left+document.body.scrollLeft)/i,n=1-(t.clientY-r.top+document.body.scrollTop)/i;return n>1?n=1:n<0&&(n=0),o>1?o=1:o<0&&(o=0),g.__color.v=n,g.__color.s=o,g.setValue(g.__color.toOriginal()),!1}function f(t){t.preventDefault();var i=e.getHeight(g.__hue_field),r=e.getOffset(g.__hue_field),o=1-(t.clientY-r.top+document.body.scrollTop)/i;return o>1?o=1:o<0&&(o=0),g.__color.h=360*o,g.setValue(g.__color.toOriginal()),!1}a.superclass.call(this,t,l),this.__color=new i(this.getValue()),this.__temp=new i(0);var g=this;this.domElement=document.createElement("div"),e.makeSelectable(this.domElement,!1),this.__selector=document.createElement("div"),this.__selector.className="selector",this.__saturation_field=document.createElement("div"),this.__saturation_field.className="saturation-field",this.__field_knob=document.createElement("div"),this.__field_knob.className="field-knob",this.__field_knob_border="2px solid ",this.__hue_knob=document.createElement("div"),this.__hue_knob.className="hue-knob",this.__hue_field=document.createElement("div"),this.__hue_field.className="hue-field",this.__input=document.createElement("input"),this.__input.type="text",this.__input_textShadow="0 1px 1px ",e.bind(this.__input,"keydown",function(t){13===t.keyCode&&d.call(this)}),e.bind(this.__input,"blur",d),e.bind(this.__selector,"mousedown",function(t){e.addClass(this,"drag").bind(window,"mouseup",function(t){e.removeClass(g.__selector,"drag")})});var m=document.createElement("div");o.extend(this.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),o.extend(this.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:this.__field_knob_border+(this.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),o.extend(this.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),o.extend(this.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),o.extend(m.style,{width:"100%",height:"100%",background:"none"}),n(m,"top","rgba(0,0,0,0)","#000"),o.extend(this.__hue_field.style,{width:"15px",height:"100px",display:"inline-block",border:"1px solid #555",cursor:"ns-resize"}),s(this.__hue_field),o.extend(this.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:this.__input_textShadow+"rgba(0,0,0,0.7)"}),e.bind(this.__saturation_field,"mousedown",h),e.bind(this.__field_knob,"mousedown",h),e.bind(this.__hue_field,"mousedown",function(t){f(t),e.bind(window,"mousemove",f),e.bind(window,"mouseup",c)}),this.__saturation_field.appendChild(m),this.__selector.appendChild(this.__field_knob),this.__selector.appendChild(this.__saturation_field),this.__selector.appendChild(this.__hue_field),this.__hue_field.appendChild(this.__hue_knob),this.domElement.appendChild(this.__input),this.domElement.appendChild(this.__selector),this.updateDisplay()};a.superclass=t,o.extend(a.prototype,t.prototype,{updateDisplay:function(){var t=r(this.getValue());if(t!==!1){var e=!1;o.each(i.COMPONENTS,function(i){if(!o.isUndefined(t[i])&&!o.isUndefined(this.__color.__state[i])&&t[i]!==this.__color.__state[i])return e=!0,{}},this),e&&o.extend(this.__color.__state,t)}o.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var s=this.__color.v<.5||this.__color.s>.5?255:0,a=255-s;o.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toString(),border:this.__field_knob_border+"rgb("+s+","+s+","+s+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,n(this.__saturation_field,"left","#fff",this.__temp.toString()),o.extend(this.__input.style,{backgroundColor:this.__input.value=this.__color.toString(),color:"rgb("+s+","+s+","+s+")",textShadow:this.__input_textShadow+"rgba("+a+","+a+","+a+",.7)"})}});var l=["-moz-","-o-","-webkit-","-ms-",""];return a}(dat.controllers.Controller,dat.dom.dom,dat.color.Color=function(t,e,i,r){function o(t,e,i){Object.defineProperty(t,e,{get:function(){return"RGB"===this.__state.space?this.__state[e]:(s(this,e,i),this.__state[e])},set:function(t){"RGB"!==this.__state.space&&(s(this,e,i),this.__state.space="RGB"),this.__state[e]=t}})}function n(t,e){Object.defineProperty(t,e,{get:function(){return"HSV"===this.__state.space?this.__state[e]:(a(this),this.__state[e])},set:function(t){"HSV"!==this.__state.space&&(a(this),this.__state.space="HSV"),this.__state[e]=t}})}function s(t,i,o){if("HEX"===t.__state.space)t.__state[i]=e.component_from_hex(t.__state.hex,o);else{if("HSV"!==t.__state.space)throw"Corrupted color state";r.extend(t.__state,e.hsv_to_rgb(t.__state.h,t.__state.s,t.__state.v))}}function a(t){var i=e.rgb_to_hsv(t.r,t.g,t.b);r.extend(t.__state,{s:i.s,v:i.v}),r.isNaN(i.h)?r.isUndefined(t.__state.h)&&(t.__state.h=0):t.__state.h=i.h}var l=function(){if(this.__state=t.apply(this,arguments),this.__state===!1)throw"Failed to interpret color arguments";this.__state.a=this.__state.a||1};return l.COMPONENTS=["r","g","b","h","s","v","hex","a"],r.extend(l.prototype,{toString:function(){return i(this)},toOriginal:function(){return this.__state.conversion.write(this)}}),o(l.prototype,"r",2),o(l.prototype,"g",1),o(l.prototype,"b",0),n(l.prototype,"h"),n(l.prototype,"s"),n(l.prototype,"v"),Object.defineProperty(l.prototype,"a",{get:function(){return this.__state.a},set:function(t){this.__state.a=t}}),Object.defineProperty(l.prototype,"hex",{get:function(){return"HEX"!==!this.__state.space&&(this.__state.hex=e.rgb_to_hex(this.r,this.g,this.b)),this.__state.hex},set:function(t){this.__state.space="HEX",this.__state.hex=t}}),l}(dat.color.interpret,dat.color.math=function(){var t;return{hsv_to_rgb:function(t,e,i){var r=Math.floor(t/60)%6,o=t/60-Math.floor(t/60),n=i*(1-e),s=i*(1-o*e),a=i*(1-(1-o)*e),l=[[i,a,n],[s,i,n],[n,i,a],[n,s,i],[a,n,i],[i,n,s]][r];return{r:255*l[0],g:255*l[1],b:255*l[2]}},rgb_to_hsv:function(t,e,i){var r,o,n=Math.min(t,e,i),s=Math.max(t,e,i),a=s-n;return 0==s?{h:NaN,s:0,v:0}:(o=a/s,r=t==s?(e-i)/a:e==s?2+(i-t)/a:4+(t-e)/a,r/=6,r<0&&(r+=1),{h:360*r,s:o,v:s/255})},rgb_to_hex:function(t,e,i){var r=this.hex_with_component(0,2,t);return r=this.hex_with_component(r,1,e),r=this.hex_with_component(r,0,i)},component_from_hex:function(t,e){return t>>8*e&255},hex_with_component:function(e,i,r){return r<<(t=8*i)|e&~(255<<t)}}}(),dat.color.toString,dat.utils.common),dat.color.interpret,dat.utils.common),dat.utils.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)}}(),dat.dom.CenteredDiv=function(t,e){var i=function(){this.backgroundElement=document.createElement("div"),e.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear"}),t.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),e.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var i=this;t.bind(this.backgroundElement,"click",function(){i.hide()})};return i.prototype.show=function(){var t=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),e.defer(function(){t.backgroundElement.style.opacity=1,t.domElement.style.opacity=1,t.domElement.style.webkitTransform="scale(1)"})},i.prototype.hide=function(){var e=this,i=function(){e.domElement.style.display="none",e.backgroundElement.style.display="none",t.unbind(e.domElement,"webkitTransitionEnd",i),t.unbind(e.domElement,"transitionend",i),t.unbind(e.domElement,"oTransitionEnd",i)};t.bind(this.domElement,"webkitTransitionEnd",i),t.bind(this.domElement,"transitionend",i),t.bind(this.domElement,"oTransitionEnd",i),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"},i.prototype.layout=function(){this.domElement.style.left=window.innerWidth/2-t.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-t.getHeight(this.domElement)/2+"px"},i}(dat.dom.dom,dat.utils.common),dat.dom.dom,dat.utils.common),function(t,e){"object"==typeof exports?module.exports=e(global):"function"==typeof define&&define.amd?define([],function(){return e(t)}):e(t)}(this,function(t){"use strict";function e(t){return n=t}function i(){return n="undefined"!=typeof Float32Array?Float32Array:Array}var r=1e-6,o={};!function(){if("undefined"!=typeof Float32Array){var t=new Float32Array(1),e=new Int32Array(t.buffer);o.invsqrt=function(i){var r=.5*i;t[0]=i;var o=1.5;e[0]=1597463007-(e[0]>>1);var n=t[0];return n*(o-r*n*n)}}else o.invsqrt=function(t){return 1/Math.sqrt(t)}}();var n=null;i();var s={};s.create=function(t){var e=new n(3);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):e[0]=e[1]=e[2]=0,e},s.createFrom=function(t,e,i){var r=new n(3);return r[0]=t,r[1]=e,r[2]=i,r},s.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},s.equal=function(t,e){return t===e||Math.abs(t[0]-e[0])<r&&Math.abs(t[1]-e[1])<r&&Math.abs(t[2]-e[2])<r},s.add=function(t,e,i){return i&&t!==i?(i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t)},s.subtract=function(t,e,i){return i&&t!==i?(i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i):(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t)},s.multiply=function(t,e,i){return i&&t!==i?(i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i):(t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t)},s.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},s.scale=function(t,e,i){return i&&t!==i?(i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i):(t[0]*=e,t[1]*=e,t[2]*=e,t)},s.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],o=t[2],n=Math.sqrt(i*i+r*r+o*o);return n?1===n?(e[0]=i,e[1]=r,e[2]=o,e):(n=1/n,e[0]=i*n,e[1]=r*n,e[2]=o*n,e):(e[0]=0,e[1]=0,e[2]=0,e)},s.cross=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2],s=e[0],a=e[1],l=e[2];return i[0]=o*l-n*a,i[1]=n*s-r*l,i[2]=r*a-o*s,i},s.length=function(t){var e=t[0],i=t[1],r=t[2];return Math.sqrt(e*e+i*i+r*r)},s.squaredLength=function(t){var e=t[0],i=t[1],r=t[2];return e*e+i*i+r*r},s.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},s.direction=function(t,e,i){i||(i=t);var r=t[0]-e[0],o=t[1]-e[1],n=t[2]-e[2],s=Math.sqrt(r*r+o*o+n*n);return s?(s=1/s,i[0]=r*s,i[1]=o*s,i[2]=n*s,i):(i[0]=0,i[1]=0,i[2]=0,i)},s.lerp=function(t,e,i,r){return r||(r=t),r[0]=t[0]+i*(e[0]-t[0]),r[1]=t[1]+i*(e[1]-t[1]),r[2]=t[2]+i*(e[2]-t[2]),r},s.dist=function(t,e){var i=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(i*i+r*r+o*o)};var a=null,l=new n(4);s.unproject=function(t,e,i,r,o){o||(o=t),a||(a=f.create());var n=a,s=l;return s[0]=2*(t[0]-r[0])/r[2]-1,s[1]=2*(t[1]-r[1])/r[3]-1,s[2]=2*t[2]-1,s[3]=1,f.multiply(i,e,n),f.inverse(n)?(f.multiplyVec4(n,s),0===s[3]?null:(o[0]=s[0]/s[3],o[1]=s[1]/s[3],o[2]=s[2]/s[3],o)):null};var h=s.createFrom(1,0,0),u=s.createFrom(0,1,0),d=s.createFrom(0,0,1),c=s.create();s.rotationTo=function(t,e,i){i||(i=g.create());var r=s.dot(t,e),o=c;if(r>=1)g.set(m,i);else if(r<1e-6-1)s.cross(h,t,o),s.length(o)<1e-6&&s.cross(u,t,o),s.length(o)<1e-6&&s.cross(d,t,o),s.normalize(o),g.fromAngleAxis(Math.PI,o,i);else{var n=Math.sqrt(2*(1+r)),a=1/n;s.cross(t,e,o),i[0]=o[0]*a,i[1]=o[1]*a,i[2]=o[2]*a,i[3]=.5*n,g.normalize(i)}return i[3]>1?i[3]=1:i[3]<-1&&(i[3]=-1),i},s.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+"]"};var p={};p.create=function(t){var e=new n(9);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8]):e[0]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=0,e},p.createFrom=function(t,e,i,r,o,s,a,l,h){var u=new n(9);return u[0]=t,u[1]=e,u[2]=i,u[3]=r,u[4]=o,u[5]=s,u[6]=a,u[7]=l,u[8]=h,u},p.determinant=function(t){var e=t[0],i=t[1],r=t[2],o=t[3],n=t[4],s=t[5],a=t[6],l=t[7],h=t[8];return e*(h*n-s*l)+i*(-h*o+s*a)+r*(l*o-n*a)},p.inverse=function(t,e){var i,r=t[0],o=t[1],n=t[2],s=t[3],a=t[4],l=t[5],h=t[6],u=t[7],d=t[8],c=d*a-l*u,f=-d*s+l*h,g=u*s-a*h,m=r*c+o*f+n*g;return m?(i=1/m,e||(e=p.create()),e[0]=c*i,e[1]=(-d*o+n*u)*i,e[2]=(l*o-n*a)*i,e[3]=f*i,e[4]=(d*r-n*h)*i,e[5]=(-l*r+n*s)*i,e[6]=g*i,e[7]=(-u*r+o*h)*i,e[8]=(a*r-o*s)*i,e):null},p.multiply=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2],s=t[3],a=t[4],l=t[5],h=t[6],u=t[7],d=t[8],c=e[0],p=e[1],f=e[2],g=e[3],m=e[4],v=e[5],b=e[6],_=e[7],w=e[8];return i[0]=c*r+p*s+f*h,i[1]=c*o+p*a+f*u,i[2]=c*n+p*l+f*d,i[3]=g*r+m*s+v*h,i[4]=g*o+m*a+v*u,i[5]=g*n+m*l+v*d,i[6]=b*r+_*s+w*h,i[7]=b*o+_*a+w*u,i[8]=b*n+_*l+w*d,i},p.multiplyVec2=function(t,e,i){i||(i=e);var r=e[0],o=e[1];return i[0]=r*t[0]+o*t[3]+t[6],i[1]=r*t[1]+o*t[4]+t[7],i},p.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],o=e[1],n=e[2];return i[0]=r*t[0]+o*t[3]+n*t[6],i[1]=r*t[1]+o*t[4]+n*t[7],i[2]=r*t[2]+o*t[5]+n*t[8],i},p.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},p.equal=function(t,e){return t===e||Math.abs(t[0]-e[0])<r&&Math.abs(t[1]-e[1])<r&&Math.abs(t[2]-e[2])<r&&Math.abs(t[3]-e[3])<r&&Math.abs(t[4]-e[4])<r&&Math.abs(t[5]-e[5])<r&&Math.abs(t[6]-e[6])<r&&Math.abs(t[7]-e[7])<r&&Math.abs(t[8]-e[8])<r},p.identity=function(t){return t||(t=p.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},p.transpose=function(t,e){if(!e||t===e){var i=t[1],r=t[2],o=t[5];return t[1]=t[3],t[2]=t[6],t[3]=i,t[5]=t[7],t[6]=r,t[7]=o,t}return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},p.toMat4=function(t,e){return e||(e=f.create()),e[15]=1,e[14]=0,e[13]=0,e[12]=0,e[11]=0,e[10]=t[8],e[9]=t[7],e[8]=t[6],e[7]=0,e[6]=t[5],e[5]=t[4],e[4]=t[3],e[3]=0,e[2]=t[2],e[1]=t[1],e[0]=t[0],e},p.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+"]"};var f={};f.create=function(t){var e=new n(16);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e},f.createFrom=function(t,e,i,r,o,s,a,l,h,u,d,c,p,f,g,m){var v=new n(16);return v[0]=t,v[1]=e,v[2]=i,v[3]=r,v[4]=o,v[5]=s,v[6]=a,v[7]=l,v[8]=h,v[9]=u,v[10]=d,v[11]=c,v[12]=p,v[13]=f,v[14]=g,v[15]=m,v},f.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},f.equal=function(t,e){return t===e||Math.abs(t[0]-e[0])<r&&Math.abs(t[1]-e[1])<r&&Math.abs(t[2]-e[2])<r&&Math.abs(t[3]-e[3])<r&&Math.abs(t[4]-e[4])<r&&Math.abs(t[5]-e[5])<r&&Math.abs(t[6]-e[6])<r&&Math.abs(t[7]-e[7])<r&&Math.abs(t[8]-e[8])<r&&Math.abs(t[9]-e[9])<r&&Math.abs(t[10]-e[10])<r&&Math.abs(t[11]-e[11])<r&&Math.abs(t[12]-e[12])<r&&Math.abs(t[13]-e[13])<r&&Math.abs(t[14]-e[14])<r&&Math.abs(t[15]-e[15])<r},f.identity=function(t){return t||(t=f.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},f.transpose=function(t,e){if(!e||t===e){var i=t[1],r=t[2],o=t[3],n=t[6],s=t[7],a=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=i,t[6]=t[9],t[7]=t[13],t[8]=r,t[9]=n,t[11]=t[14],t[12]=o,t[13]=s,t[14]=a,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},f.determinant=function(t){var e=t[0],i=t[1],r=t[2],o=t[3],n=t[4],s=t[5],a=t[6],l=t[7],h=t[8],u=t[9],d=t[10],c=t[11],p=t[12],f=t[13],g=t[14],m=t[15];return p*u*a*o-h*f*a*o-p*s*d*o+n*f*d*o+h*s*g*o-n*u*g*o-p*u*r*l+h*f*r*l+p*i*d*l-e*f*d*l-h*i*g*l+e*u*g*l+p*s*r*c-n*f*r*c-p*i*a*c+e*f*a*c+n*i*g*c-e*s*g*c-h*s*r*m+n*u*r*m+h*i*a*m-e*u*a*m-n*i*d*m+e*s*d*m},f.inverse=function(t,e){e||(e=t);var i,r=t[0],o=t[1],n=t[2],s=t[3],a=t[4],l=t[5],h=t[6],u=t[7],d=t[8],c=t[9],p=t[10],f=t[11],g=t[12],m=t[13],v=t[14],b=t[15],_=r*l-o*a,w=r*h-n*a,y=r*u-s*a,x=o*h-n*l,A=o*u-s*l,E=n*u-s*h,C=d*m-c*g,S=d*v-p*g,M=d*b-f*g,k=c*v-p*m,T=c*b-f*m,R=p*b-f*v,B=_*R-w*T+y*k+x*M-A*S+E*C;return B?(i=1/B,e[0]=(l*R-h*T+u*k)*i,e[1]=(-o*R+n*T-s*k)*i,e[2]=(m*E-v*A+b*x)*i,e[3]=(-c*E+p*A-f*x)*i,e[4]=(-a*R+h*M-u*S)*i,e[5]=(r*R-n*M+s*S)*i,e[6]=(-g*E+v*y-b*w)*i,e[7]=(d*E-p*y+f*w)*i,e[8]=(a*T-l*M+u*C)*i,e[9]=(-r*T+o*M-s*C)*i,e[10]=(g*A-m*y+b*_)*i,e[11]=(-d*A+c*y-f*_)*i,e[12]=(-a*k+l*S-h*C)*i,e[13]=(r*k-o*S+n*C)*i,e[14]=(-g*x+m*w-v*_)*i,e[15]=(d*x-c*w+p*_)*i,e):null},f.toRotationMat=function(t,e){return e||(e=f.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},f.toMat3=function(t,e){return e||(e=p.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},f.toInverseMat3=function(t,e){var i,r=t[0],o=t[1],n=t[2],s=t[4],a=t[5],l=t[6],h=t[8],u=t[9],d=t[10],c=d*a-l*u,f=-d*s+l*h,g=u*s-a*h,m=r*c+o*f+n*g;return m?(i=1/m,e||(e=p.create()),e[0]=c*i,e[1]=(-d*o+n*u)*i,e[2]=(l*o-n*a)*i,e[3]=f*i,e[4]=(d*r-n*h)*i,e[5]=(-l*r+n*s)*i,e[6]=g*i,e[7]=(-u*r+o*h)*i,e[8]=(a*r-o*s)*i,e):null},f.multiply=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2],s=t[3],a=t[4],l=t[5],h=t[6],u=t[7],d=t[8],c=t[9],p=t[10],f=t[11],g=t[12],m=t[13],v=t[14],b=t[15],_=e[0],w=e[1],y=e[2],x=e[3];return i[0]=_*r+w*a+y*d+x*g,i[1]=_*o+w*l+y*c+x*m,i[2]=_*n+w*h+y*p+x*v,i[3]=_*s+w*u+y*f+x*b,_=e[4],w=e[5],y=e[6],x=e[7],i[4]=_*r+w*a+y*d+x*g,i[5]=_*o+w*l+y*c+x*m,i[6]=_*n+w*h+y*p+x*v,i[7]=_*s+w*u+y*f+x*b,_=e[8],w=e[9],y=e[10],x=e[11],i[8]=_*r+w*a+y*d+x*g,i[9]=_*o+w*l+y*c+x*m,i[10]=_*n+w*h+y*p+x*v,i[11]=_*s+w*u+y*f+x*b,_=e[12],w=e[13],y=e[14],x=e[15],i[12]=_*r+w*a+y*d+x*g,i[13]=_*o+w*l+y*c+x*m,i[14]=_*n+w*h+y*p+x*v,i[15]=_*s+w*u+y*f+x*b,i},f.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],o=e[1],n=e[2];return i[0]=t[0]*r+t[4]*o+t[8]*n+t[12],i[1]=t[1]*r+t[5]*o+t[9]*n+t[13],i[2]=t[2]*r+t[6]*o+t[10]*n+t[14],i},f.multiplyVec4=function(t,e,i){i||(i=e);var r=e[0],o=e[1],n=e[2],s=e[3];return i[0]=t[0]*r+t[4]*o+t[8]*n+t[12]*s,i[1]=t[1]*r+t[5]*o+t[9]*n+t[13]*s,i[2]=t[2]*r+t[6]*o+t[10]*n+t[14]*s,i[3]=t[3]*r+t[7]*o+t[11]*n+t[15]*s,i},f.translate=function(t,e,i){var r,o,n,s,a,l,h,u,d,c,p,f,g=e[0],m=e[1],v=e[2];return i&&t!==i?(r=t[0],o=t[1],n=t[2],s=t[3],a=t[4],l=t[5],h=t[6],u=t[7],d=t[8],c=t[9],p=t[10],f=t[11],i[0]=r,i[1]=o,i[2]=n,i[3]=s,i[4]=a,i[5]=l,i[6]=h,i[7]=u,i[8]=d,i[9]=c,i[10]=p,i[11]=f,i[12]=r*g+a*m+d*v+t[12],i[13]=o*g+l*m+c*v+t[13],i[14]=n*g+h*m+p*v+t[14],i[15]=s*g+u*m+f*v+t[15],i):(t[12]=t[0]*g+t[4]*m+t[8]*v+t[12],t[13]=t[1]*g+t[5]*m+t[9]*v+t[13],t[14]=t[2]*g+t[6]*m+t[10]*v+t[14],t[15]=t[3]*g+t[7]*m+t[11]*v+t[15],t)},f.scale=function(t,e,i){var r=e[0],o=e[1],n=e[2];return i&&t!==i?(i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3]*r,i[4]=t[4]*o,i[5]=t[5]*o,i[6]=t[6]*o,i[7]=t[7]*o,i[8]=t[8]*n,i[9]=t[9]*n,i[10]=t[10]*n,i[11]=t[11]*n,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i):(t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r,t[4]*=o,t[5]*=o,t[6]*=o,t[7]*=o,t[8]*=n,t[9]*=n,t[10]*=n,t[11]*=n,t)},f.rotate=function(t,e,i,r){var o,n,s,a,l,h,u,d,c,p,f,g,m,v,b,_,w,y,x,A,E,C,S,M,k=i[0],T=i[1],R=i[2],B=Math.sqrt(k*k+T*T+R*R);return B?(1!==B&&(B=1/B,k*=B,T*=B,R*=B),o=Math.sin(e),n=Math.cos(e),s=1-n,a=t[0],l=t[1],h=t[2],u=t[3],d=t[4],c=t[5],p=t[6],f=t[7],g=t[8],m=t[9],v=t[10],b=t[11],_=k*k*s+n,w=T*k*s+R*o,y=R*k*s-T*o,x=k*T*s-R*o,A=T*T*s+n,E=R*T*s+k*o,C=k*R*s+T*o,S=T*R*s-k*o,M=R*R*s+n,r?t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=a*_+d*w+g*y,r[1]=l*_+c*w+m*y,r[2]=h*_+p*w+v*y,r[3]=u*_+f*w+b*y,r[4]=a*x+d*A+g*E,r[5]=l*x+c*A+m*E,r[6]=h*x+p*A+v*E,r[7]=u*x+f*A+b*E,r[8]=a*C+d*S+g*M,r[9]=l*C+c*S+m*M,r[10]=h*C+p*S+v*M,r[11]=u*C+f*S+b*M,r):null},f.rotateX=function(t,e,i){var r=Math.sin(e),o=Math.cos(e),n=t[4],s=t[5],a=t[6],l=t[7],h=t[8],u=t[9],d=t[10],c=t[11];return i?t!==i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[4]=n*o+h*r,i[5]=s*o+u*r,i[6]=a*o+d*r,i[7]=l*o+c*r,i[8]=n*-r+h*o,i[9]=s*-r+u*o,i[10]=a*-r+d*o,i[11]=l*-r+c*o,i},f.rotateY=function(t,e,i){var r=Math.sin(e),o=Math.cos(e),n=t[0],s=t[1],a=t[2],l=t[3],h=t[8],u=t[9],d=t[10],c=t[11];return i?t!==i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*o+h*-r,i[1]=s*o+u*-r,i[2]=a*o+d*-r,i[3]=l*o+c*-r,i[8]=n*r+h*o,i[9]=s*r+u*o,i[10]=a*r+d*o,i[11]=l*r+c*o,i},f.rotateZ=function(t,e,i){var r=Math.sin(e),o=Math.cos(e),n=t[0],s=t[1],a=t[2],l=t[3],h=t[4],u=t[5],d=t[6],c=t[7];return i?t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*o+h*r,i[1]=s*o+u*r,i[2]=a*o+d*r,i[3]=l*o+c*r,i[4]=n*-r+h*o,i[5]=s*-r+u*o,i[6]=a*-r+d*o,i[7]=l*-r+c*o,i},f.frustum=function(t,e,i,r,o,n,s){s||(s=f.create());var a=e-t,l=r-i,h=n-o;return s[0]=2*o/a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*o/l,s[6]=0,s[7]=0,s[8]=(e+t)/a,s[9]=(r+i)/l,s[10]=-(n+o)/h,s[11]=-1,s[12]=0,s[13]=0,s[14]=-(n*o*2)/h,s[15]=0,s},f.perspective=function(t,e,i,r,o){var n=i*Math.tan(t*Math.PI/360),s=n*e;return f.frustum(-s,s,-n,n,i,r,o)},f.ortho=function(t,e,i,r,o,n,s){s||(s=f.create());var a=e-t,l=r-i,h=n-o;return s[0]=2/a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2/l,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2/h,s[11]=0,s[12]=-(t+e)/a,s[13]=-(r+i)/l,s[14]=-(n+o)/h,s[15]=1,s},f.lookAt=function(t,e,i,r){r||(r=f.create());var o,n,s,a,l,h,u,d,c,p,g=t[0],m=t[1],v=t[2],b=i[0],_=i[1],w=i[2],y=e[0],x=e[1],A=e[2];return g===y&&m===x&&v===A?f.identity(r):(u=g-y,d=m-x,c=v-A,p=1/Math.sqrt(u*u+d*d+c*c),u*=p,d*=p,c*=p,o=_*c-w*d,n=w*u-b*c,s=b*d-_*u,p=Math.sqrt(o*o+n*n+s*s),p?(p=1/p,o*=p,n*=p,s*=p):(o=0,n=0,s=0),a=d*s-c*n,l=c*o-u*s,h=u*n-d*o,p=Math.sqrt(a*a+l*l+h*h),p?(p=1/p,a*=p,l*=p,h*=p):(a=0,l=0,h=0),r[0]=o,r[1]=a,r[2]=u,r[3]=0,r[4]=n,r[5]=l,r[6]=d,r[7]=0,r[8]=s,r[9]=h,r[10]=c,r[11]=0,r[12]=-(o*g+n*m+s*v),r[13]=-(a*g+l*m+h*v),r[14]=-(u*g+d*m+c*v),r[15]=1,r)},f.fromRotationTranslation=function(t,e,i){i||(i=f.create());var r=t[0],o=t[1],n=t[2],s=t[3],a=r+r,l=o+o,h=n+n,u=r*a,d=r*l,c=r*h,p=o*l,g=o*h,m=n*h,v=s*a,b=s*l,_=s*h;return i[0]=1-(p+m),i[1]=d+_,i[2]=c-b,i[3]=0,i[4]=d-_,i[5]=1-(u+m),i[6]=g+v,i[7]=0,i[8]=c+b,i[9]=g-v,i[10]=1-(u+p),i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i},f.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+"]"};var g={};g.create=function(t){var e=new n(4);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):e[0]=e[1]=e[2]=e[3]=0,e},g.createFrom=function(t,e,i,r){var o=new n(4);return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o},g.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},g.equal=function(t,e){return t===e||Math.abs(t[0]-e[0])<r&&Math.abs(t[1]-e[1])<r&&Math.abs(t[2]-e[2])<r&&Math.abs(t[3]-e[3])<r},g.identity=function(t){return t||(t=g.create()),t[0]=0,t[1]=0,t[2]=0,t[3]=1,t};var m=g.identity();g.calculateW=function(t,e){var i=t[0],r=t[1],o=t[2];return e&&t!==e?(e[0]=i,e[1]=r,e[2]=o,e[3]=-Math.sqrt(Math.abs(1-i*i-r*r-o*o)),e):(t[3]=-Math.sqrt(Math.abs(1-i*i-r*r-o*o)),t)},g.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},g.inverse=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=i*i+r*r+o*o+n*n,a=s?1/s:0;return e&&t!==e?(e[0]=-t[0]*a,e[1]=-t[1]*a,e[2]=-t[2]*a,e[3]=t[3]*a,e):(t[0]*=-a,t[1]*=-a,t[2]*=-a,t[3]*=a,t)},g.conjugate=function(t,e){return e&&t!==e?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e):(t[0]*=-1,t[1]*=-1,t[2]*=-1,t)},g.length=function(t){var e=t[0],i=t[1],r=t[2],o=t[3];return Math.sqrt(e*e+i*i+r*r+o*o)},g.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],o=t[2],n=t[3],s=Math.sqrt(i*i+r*r+o*o+n*n);return 0===s?(e[0]=0,e[1]=0,e[2]=0,e[3]=0,e):(s=1/s,e[0]=i*s,e[1]=r*s,e[2]=o*s,e[3]=n*s,e)},g.add=function(t,e,i){return i&&t!==i?(i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[3],t)},g.multiply=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2],s=t[3],a=e[0],l=e[1],h=e[2],u=e[3];return i[0]=r*u+s*a+o*h-n*l,i[1]=o*u+s*l+n*a-r*h,i[2]=n*u+s*h+r*l-o*a,i[3]=s*u-r*a-o*l-n*h,i},g.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],o=e[1],n=e[2],s=t[0],a=t[1],l=t[2],h=t[3],u=h*r+a*n-l*o,d=h*o+l*r-s*n,c=h*n+s*o-a*r,p=-s*r-a*o-l*n;return i[0]=u*h+p*-s+d*-l-c*-a,i[1]=d*h+p*-a+c*-s-u*-l,i[2]=c*h+p*-l+u*-a-d*-s,i},g.scale=function(t,e,i){return i&&t!==i?(i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i):(t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t)},g.toMat3=function(t,e){e||(e=p.create());var i=t[0],r=t[1],o=t[2],n=t[3],s=i+i,a=r+r,l=o+o,h=i*s,u=i*a,d=i*l,c=r*a,f=r*l,g=o*l,m=n*s,v=n*a,b=n*l;return e[0]=1-(c+g),e[1]=u+b,e[2]=d-v,e[3]=u-b,e[4]=1-(h+g),e[5]=f+m,e[6]=d+v,e[7]=f-m,e[8]=1-(h+c),e},g.toMat4=function(t,e){e||(e=f.create());var i=t[0],r=t[1],o=t[2],n=t[3],s=i+i,a=r+r,l=o+o,h=i*s,u=i*a,d=i*l,c=r*a,p=r*l,g=o*l,m=n*s,v=n*a,b=n*l;return e[0]=1-(c+g),e[1]=u+b,e[2]=d-v,e[3]=0,e[4]=u-b,e[5]=1-(h+g),e[6]=p+m,e[7]=0,e[8]=d+v,e[9]=p-m,e[10]=1-(h+c),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},g.slerp=function(t,e,i,r){r||(r=t);var o,n,s,a,l=t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3];return Math.abs(l)>=1?(r!==t&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),r):(o=Math.acos(l),n=Math.sqrt(1-l*l),Math.abs(n)<.001?(r[0]=.5*t[0]+.5*e[0],r[1]=.5*t[1]+.5*e[1],r[2]=.5*t[2]+.5*e[2],r[3]=.5*t[3]+.5*e[3],r):(s=Math.sin((1-i)*o)/n,a=Math.sin(i*o)/n,r[0]=t[0]*s+e[0]*a,r[1]=t[1]*s+e[1]*a,r[2]=t[2]*s+e[2]*a,r[3]=t[3]*s+e[3]*a,r))},g.fromRotationMatrix=function(t,e){e||(e=g.create());var i,r=t[0]+t[4]+t[8];if(r>0)i=Math.sqrt(r+1),e[3]=.5*i,i=.5/i,e[0]=(t[7]-t[5])*i,e[1]=(t[2]-t[6])*i,e[2]=(t[3]-t[1])*i;else{var o=g.fromRotationMatrix.s_iNext=g.fromRotationMatrix.s_iNext||[1,2,0],n=0;t[4]>t[0]&&(n=1),t[8]>t[3*n+n]&&(n=2);var s=o[n],a=o[s];i=Math.sqrt(t[3*n+n]-t[3*s+s]-t[3*a+a]+1),e[n]=.5*i,i=.5/i,e[3]=(t[3*a+s]-t[3*s+a])*i,e[s]=(t[3*s+n]+t[3*n+s])*i,e[a]=(t[3*a+n]+t[3*n+a])*i}return e},p.toQuat4=g.fromRotationMatrix,function(){var t=p.create();g.fromAxes=function(e,i,r,o){return t[0]=i[0],t[3]=i[1],t[6]=i[2],t[1]=r[0],t[4]=r[1],t[7]=r[2],t[2]=e[0],t[5]=e[1],t[8]=e[2],g.fromRotationMatrix(t,o)}}(),g.identity=function(t){return t||(t=g.create()),t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},g.fromAngleAxis=function(t,e,i){i||(i=g.create());var r=.5*t,o=Math.sin(r);return i[3]=Math.cos(r),i[0]=o*e[0],i[1]=o*e[1],i[2]=o*e[2],i},g.toAngleAxis=function(t,e){e||(e=t);var i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){e[3]=2*Math.acos(t[3]);var r=o.invsqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}else e[3]=0,e[0]=1,e[1]=0,e[2]=0;return e},g.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"};var v={};v.create=function(t){var e=new n(2);return t?(e[0]=t[0],e[1]=t[1]):(e[0]=0,e[1]=0),e},v.createFrom=function(t,e){var i=new n(2);return i[0]=t,i[1]=e,i},v.add=function(t,e,i){return i||(i=e),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i},v.subtract=function(t,e,i){return i||(i=e),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i},v.multiply=function(t,e,i){return i||(i=e),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i},v.divide=function(t,e,i){return i||(i=e),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i},v.scale=function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i},v.dist=function(t,e){var i=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(i*i+r*r)},v.set=function(t,e){return e[0]=t[0],e[1]=t[1],e},v.equal=function(t,e){return t===e||Math.abs(t[0]-e[0])<r&&Math.abs(t[1]-e[1])<r},v.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e},v.normalize=function(t,e){e||(e=t);var i=t[0]*t[0]+t[1]*t[1];return i>0?(i=Math.sqrt(i),e[0]=t[0]/i,e[1]=t[1]/i):e[0]=e[1]=0,e},v.cross=function(t,e,i){var r=t[0]*e[1]-t[1]*e[0];return i?(i[0]=i[1]=0,i[2]=r,i):r},v.length=function(t){var e=t[0],i=t[1];return Math.sqrt(e*e+i*i)},v.squaredLength=function(t){var e=t[0],i=t[1];return e*e+i*i},v.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},v.direction=function(t,e,i){i||(i=t);var r=t[0]-e[0],o=t[1]-e[1],n=r*r+o*o;return n?(n=1/Math.sqrt(n),i[0]=r*n,i[1]=o*n,i):(i[0]=0,i[1]=0,i[2]=0,i)},v.lerp=function(t,e,i,r){return r||(r=t),r[0]=t[0]+i*(e[0]-t[0]),r[1]=t[1]+i*(e[1]-t[1]),r},v.str=function(t){return"["+t[0]+", "+t[1]+"]"};var b={};b.create=function(t){var e=new n(4);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):e[0]=e[1]=e[2]=e[3]=0,e},b.createFrom=function(t,e,i,r){var o=new n(4);return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o},b.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},b.equal=function(t,e){return t===e||Math.abs(t[0]-e[0])<r&&Math.abs(t[1]-e[1])<r&&Math.abs(t[2]-e[2])<r&&Math.abs(t[3]-e[3])<r},b.identity=function(t){return t||(t=b.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},
b.transpose=function(t,e){if(!e||t===e){var i=t[1];return t[1]=t[2],t[2]=i,t}return e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3],e},b.determinant=function(t){return t[0]*t[3]-t[2]*t[1]},b.inverse=function(t,e){e||(e=t);var i=t[0],r=t[1],o=t[2],n=t[3],s=i*n-o*r;return s?(s=1/s,e[0]=n*s,e[1]=-r*s,e[2]=-o*s,e[3]=i*s,e):null},b.multiply=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2],s=t[3];return i[0]=r*e[0]+o*e[2],i[1]=r*e[1]+o*e[3],i[2]=n*e[0]+s*e[2],i[3]=n*e[1]+s*e[3],i},b.rotate=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2],s=t[3],a=Math.sin(e),l=Math.cos(e);return i[0]=r*l+o*a,i[1]=r*-a+o*l,i[2]=n*l+s*a,i[3]=n*-a+s*l,i},b.multiplyVec2=function(t,e,i){i||(i=e);var r=e[0],o=e[1];return i[0]=r*t[0]+o*t[1],i[1]=r*t[2]+o*t[3],i},b.scale=function(t,e,i){i||(i=t);var r=t[0],o=t[1],n=t[2],s=t[3],a=e[0],l=e[1];return i[0]=r*a,i[1]=o*l,i[2]=n*a,i[3]=s*l,i},b.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"};var _={};return _.create=function(t){var e=new n(4);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e},_.createFrom=function(t,e,i,r){var o=new n(4);return o[0]=t,o[1]=e,o[2]=i,o[3]=r,o},_.add=function(t,e,i){return i||(i=e),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i},_.subtract=function(t,e,i){return i||(i=e),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i},_.multiply=function(t,e,i){return i||(i=e),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i[3]=t[3]*e[3],i},_.divide=function(t,e,i){return i||(i=e),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i[3]=t[3]/e[3],i},_.scale=function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i},_.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},_.equal=function(t,e){return t===e||Math.abs(t[0]-e[0])<r&&Math.abs(t[1]-e[1])<r&&Math.abs(t[2]-e[2])<r&&Math.abs(t[3]-e[3])<r},_.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},_.length=function(t){var e=t[0],i=t[1],r=t[2],o=t[3];return Math.sqrt(e*e+i*i+r*r+o*o)},_.squaredLength=function(t){var e=t[0],i=t[1],r=t[2],o=t[3];return e*e+i*i+r*r+o*o},_.lerp=function(t,e,i,r){return r||(r=t),r[0]=t[0]+i*(e[0]-t[0]),r[1]=t[1]+i*(e[1]-t[1]),r[2]=t[2]+i*(e[2]-t[2]),r[3]=t[3]+i*(e[3]-t[3]),r},_.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"},t&&(t.glMatrixArrayType=n,t.MatrixArray=n,t.setMatrixArrayType=e,t.determineMatrixArrayType=i,t.glMath=o,t.vec2=v,t.vec3=s,t.vec4=_,t.mat2=b,t.mat3=p,t.mat4=f,t.quat4=g),{glMatrixArrayType:n,MatrixArray:n,setMatrixArrayType:e,determineMatrixArrayType:i,glMath:o,vec2:v,vec3:s,vec4:_,mat2:b,mat3:p,mat4:f,quat4:g}});var OK=function(){var t={};return t.debug_on=!1,t.debug=function(e){if(t.debug_on){var i=document.getElementById("console");i?i.innerHTML="<div style=\"font-family: 'monospace'; font-size: 8pt;\">"+e+"</div>"+i.innerHTML:console.log(e)}},t.clear=function(){var t=document.getElementById("console");t&&(t.innerHTML="")},t}();window.$||(window.$=function(t,e){return("object"==typeof e?e:document).getElementById(t)}),window.$S||(window.$S=function(t){if(t=$(t))return t.style}),window.toggle||(window.toggle=function(t){var e=$S(t).display;"none"!=e&&e?$S(t).display="none":$S(t).display="block"}),window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame}());var defaultMouse,dragMouse;Mouse.prototype.setDefault=function(){defaultMouse=document.mouse=this},Mouse.prototype.update=function(t){if(!t)var t=window.event;var e=mousePageCoord(t);this.x=e[0],this.y=e[1],this.absoluteX=this.x,this.absoluteY=this.y;var i=findElementPos(this.element);this.x-=i[0],this.y-=i[1],this.clientx=t.clientX-i[0],this.clienty=t.clientY-i[1]},WebGL.prototype.setMatrices=function(){if(this.gl.uniformMatrix4fv(this.program.mvMatrixUniform,!1,this.modelView.matrix),this.gl.uniformMatrix4fv(this.program.pMatrixUniform,!1,this.perspective.matrix),this.program.nMatrixUniform){var t=mat4.create(this.modelView.matrix);mat4.inverse(t),mat4.transpose(t),this.gl.uniformMatrix4fv(this.program.nMatrixUniform,!1,t)}},WebGL.prototype.initDraw2d=function(){this.gl.viewport(this.viewport.x,this.viewport.y,this.viewport.width,this.viewport.height),this.gl.enableVertexAttribArray(this.program.attributes.aVertexPosition),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexPositionBuffer),this.gl.vertexAttribPointer(this.program.attributes.aVertexPosition,this.vertexPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0),this.program.attributes.aTextureCoord&&(this.gl.enableVertexAttribArray(this.program.attributes.aTextureCoord),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureCoordBuffer),this.gl.vertexAttribPointer(this.program.attributes.aTextureCoord,this.textureCoordBuffer.itemSize,this.gl.FLOAT,!1,0,0)),this.setMatrices()},WebGL.prototype.updateTexture=function(t,e,i){void 0==i&&(i=this.gl.TEXTURE0),this.gl.activeTexture(i),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.bindTexture(this.gl.TEXTURE_2D,null)},WebGL.prototype.init2dBuffers=function(t){void 0==t&&(t=this.gl.TEXTURE0),this.vertexPositionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexPositionBuffer);var e=[1,1,-1,1,1,-1,-1,-1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e),this.gl.STATIC_DRAW),this.vertexPositionBuffer.itemSize=2,this.vertexPositionBuffer.numItems=4,this.gl.activeTexture(t),this.gradientTexture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.gradientTexture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.textureCoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureCoordBuffer);var i=[1,1,0,1,1,0,0,0];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(i),this.gl.STATIC_DRAW),this.textureCoordBuffer.itemSize=2,this.textureCoordBuffer.numItems=4},WebGL.prototype.loadTexture=function(t,e){return void 0==e&&(e=this.gl.NEAREST),this.texid=this.textures.length,this.textures.push(this.gl.createTexture()),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[this.texid]),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.LUMINANCE,this.gl.LUMINANCE,this.gl.UNSIGNED_BYTE,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.textures[this.texid]},WebGL.prototype.setPerspective=function(t,e,i,r){this.perspective.matrix=mat4.perspective(t,e,i,r)},WebGL.prototype.use=function(t){this.program=t,this.program.program&&this.gl.useProgram(this.program.program)},WebGLProgram.prototype.compileShader=function(t,e){var i=this.gl.createShader(e);if(this.gl.shaderSource(i,t),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw this.gl.getShaderInfoLog(i);return i},WebGLProgram.prototype.setup=function(t,e,i){if(this.program){void 0==t&&(t=["aVertexPosition","aTextureCoord"]),this.attributes={};var r;for(r in t)this.attributes[t[r]]=this.gl.getAttribLocation(this.program,t[r]),i||this.gl.enableVertexAttribArray(this.attributes[t[r]]);this.uniforms={};for(r in e)this.uniforms[e[r]]=this.gl.getUniformLocation(this.program,e[r]);this.mvMatrixUniform=this.gl.getUniformLocation(this.program,"uMVMatrix"),this.pMatrixUniform=this.gl.getUniformLocation(this.program,"uPMatrix"),this.nMatrixUniform=this.gl.getUniformLocation(this.program,"uNMatrix")}},ViewMatrix.prototype.toString=function(){return JSON.stringify(this.toArray())},ViewMatrix.prototype.toArray=function(){return JSON.parse(mat4.str(this.matrix))},ViewMatrix.prototype.push=function(t){t?(this.stack.push(mat4.create(t)),this.matrix=mat4.create(t)):this.stack.push(mat4.create(this.matrix))},ViewMatrix.prototype.pop=function(){if(0==this.stack.length)throw"Matrix stack underflow";return this.matrix=this.stack.pop(),this.matrix},ViewMatrix.prototype.mult=function(t){mat4.multiply(this.matrix,t)},ViewMatrix.prototype.identity=function(){mat4.identity(this.matrix)},ViewMatrix.prototype.scale=function(t){mat4.scale(this.matrix,t)},ViewMatrix.prototype.translate=function(t){mat4.translate(this.matrix,t)},ViewMatrix.prototype.rotate=function(t,e){var i=t*Math.PI/180;mat4.rotate(this.matrix,i,e)},Palette.prototype.sort=function(){this.colours.sort(function(t,e){return t.position-e.position})},Palette.prototype.newColour=function(t,e){var i=new ColourPos(e,t);this.colours.push(i),this.sort();for(var r=1;r<this.colours.length-1;r++)if(this.colours[r].position==t)return r;return-1},Palette.prototype.inRange=function(t,e,i){for(var r=0;r<this.colours.length;r++){var o=this.colours[r].position*i;if(t==o||e>1&&t>=o-e/2&&t<=o+e/2)return r}return-1},Palette.prototype.inDragRange=function(t,e,i){for(var r=1;r<this.colours.length-1;r++){var o=this.colours[r].position*i;if(t==o||e>1&&t>=o-e/2&&t<=o+e/2)return r}return 0},Palette.prototype.remove=function(t){this.colours.splice(t,1)},Palette.prototype.toString=function(){for(var t="Background="+this.background.html(),e=0;e<this.colours.length;e++)t+="\n"+this.colours[e].position.toFixed(6)+"="+this.colours[e].colour.html();return t},Palette.prototype.get=function(){var t={};t.background=this.background.html(),t.colours=[];for(var e=0;e<this.colours.length;e++)t.colours.push({position:this.colours[e].position,colour:this.colours[e].colour.html()});return t},Palette.prototype.toJSON=function(){return JSON.stringify(this.get())},Palette.prototype.draw=function(t,e){if(!this.slider.width&&e){var i=this;return void setTimeout(function(){i.draw(t,e)},150)}if(!t)return void alert("Invalid canvas!");var r=/webkit/.test(navigator.userAgent.toLowerCase());if(0==this.colours.length&&(this.background=new Colour("#ffffff"),this.colours.push(new ColourPos("#000000",0)),this.colours.push(new ColourPos("#ffffff",1))),list=this.colours.slice(0),list.sort(function(t,e){return t.position-e.position}),t.getContext){var o=t.width,n=t.height,s=t.getContext("2d");if(s.clearRect(0,0,o,n),r)for(var a=0,l=1;l<list.length;l++){var h=Math.round(o*list[l].position);s.fillStyle=s.createLinearGradient(a,0,h,0);var u=list[l-1].colour,d=list[l].colour;this.premultiply&&!e&&(u=this.background.blend(u),d=this.background.blend(d)),s.fillStyle.addColorStop(0,u.html()),s.fillStyle.addColorStop(1,d.html()),s.fillRect(a,0,h-a,n),a=h}else{s.fillStyle=s.createLinearGradient(0,0,o,0);for(var l=0;l<list.length;l++){var c=list[l].colour;this.premultiply&&!e&&(c=this.background.blend(c)),s.fillStyle.addColorStop(list[l].position,c.html())}s.fillRect(0,0,o,n)}var p=document.getElementById("backgroundCUR");if(p&&(p.style.background=this.background.html()),!e)return;for(var l=1;l<list.length-1;l++){var f=Math.floor(o*list[l].position)+.5,g=list[l].colour.HSV();g.V>50?s.strokeStyle="black":s.strokeStyle="white",s.beginPath(),s.moveTo(f,0),s.lineTo(f,t.height),s.closePath(),s.stroke(),f-=this.slider.width/2,s.drawImage(this.slider,f,0)}}else alert("getContext failed!")},Colour.prototype.set=function(t){t||(t="#ffffff");var e=/^rgba?\((\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,?\s*(\d\.?\d*)?\)$/,i=e.exec(t);if(i)this.red=parseInt(i[1]),this.green=parseInt(i[2]),this.blue=parseInt(i[3]),this.alpha="undefined"==typeof i[4]?1:parseFloat(i[4]);else if("#"==t.charAt(0)){var r=t.substring(1,7);this.alpha=1,this.red=parseInt(r.substring(0,2),16),this.green=parseInt(r.substring(2,4),16),this.blue=parseInt(r.substring(4,6),16)}else this.fromInt(parseInt(t))},Colour.prototype.fromInt=function(t){this.red=255&t,this.green=(65280&t)>>>8,this.blue=(16711680&t)>>>16,this.alpha=((4278190080&t)>>>24)/255},Colour.prototype.toInt=function(){var t=this.red;return t+=this.green<<8,t+=this.blue<<16,t+=Math.round(255*this.alpha)<<24},Colour.prototype.toString=function(){return this.html()},Colour.prototype.html=function(){return"rgba("+this.red+","+this.green+","+this.blue+","+this.alpha.toFixed(2)+")"},Colour.prototype.rgbaGL=function(){var t=[this.red/255,this.green/255,this.blue/255,this.alpha];return new Float32Array(t)},Colour.prototype.rgbaGLSL=function(){var t=this.rgbaGL();return"rgba("+t[0].toFixed(4)+","+t[1].toFixed(4)+","+t[2].toFixed(4)+","+t[3].toFixed(4)+")"},Colour.prototype.rgba=function(){var t=[this.red/255,this.green/255,this.blue/255,this.alpha];return t},Colour.prototype.rgbaObj=function(){return{R:this.red,G:this.green,B:this.blue,A:this.alpha}},Colour.prototype.print=function(){OK.debug(this.printString(!0))},Colour.prototype.printString=function(t){return"R:"+this.red+" G:"+this.green+" B:"+this.blue+(t?" A:"+this.alpha:"")},Colour.prototype.HEX=function(t){return t=Math.round(Math.min(Math.max(0,t),255)),"0123456789ABCDEF".charAt((t-t%16)/16)+"0123456789ABCDEF".charAt(t%16)},Colour.prototype.htmlHex=function(t){return"#"+this.HEX(this.red)+this.HEX(this.green)+this.HEX(this.blue)},Colour.prototype.hex=function(t){return this.HEX(this.red)+this.HEX(this.green)+this.HEX(this.blue)+this.HEX(255*this.alpha)},Colour.prototype.hexGL=function(t){return this.HEX(255*this.alpha)+this.HEX(this.blue)+this.HEX(this.green)+this.HEX(this.red)},Colour.prototype.setHSV=function(t){var e,i,r,o,n,s=t.S/100,a=t.V/100,l=t.H/360;if(s>0){switch(l>=1&&(l=0),l=6*l,F=l-Math.floor(l),r=Math.round(255*a*(1-s)),o=Math.round(255*a*(1-s*F)),n=Math.round(255*a*(1-s*(1-F))),a=Math.round(255*a),Math.floor(l)){case 0:e=a,i=n,o=r;break;case 1:e=o,i=a,o=r;break;case 2:e=r,i=a,o=n;break;case 3:e=r,i=o,o=a;break;case 4:e=n,i=r,o=a;break;case 5:e=a,i=r,o=o}this.red=e?e:0,this.green=i?i:0,this.blue=o?o:0}else this.red=a=Math.round(255*a),this.green=a,this.blue=a;this.alpha="undefined"==typeof t.A?1:t.A},Colour.prototype.HSV=function(){var t=this.red/255,e=this.green/255,i=this.blue/255,r=Math.min(t,e,i),o=Math.max(t,e,i);deltaMax=o-r;var n,s,a,l,h,u=o;return 0==deltaMax?(s=0,n=0):(n=deltaMax/o,a=((o-t)/6+deltaMax/2)/deltaMax,l=((o-e)/6+deltaMax/2)/deltaMax,h=((o-i)/6+deltaMax/2)/deltaMax,t==o?s=h-l:e==o?s=1/3+a-h:i==o&&(s=2/3+l-a),s<0&&(s+=1),s>1&&(s-=1)),{H:360*s,S:100*n,V:100*u}},Colour.prototype.HSVA=function(){var t=this.HSV();return t.A=this.alpha,t},Colour.prototype.interpolate=function(t,e){this.red=Math.round(this.red+e*(t.red-this.red)),this.green=Math.round(this.green+e*(t.green-this.green)),this.blue=Math.round(this.blue+e*(t.blue-this.blue)),this.alpha=Math.round(this.alpha+e*(t.alpha-this.alpha))},Colour.prototype.blend=function(t){return new Colour([Math.round((1-t.alpha)*this.red+t.alpha*t.red),Math.round((1-t.alpha)*this.green+t.alpha*t.green),Math.round((1-t.alpha)*this.blue+t.alpha*t.blue),(1-t.alpha)*this.alpha+t.alpha*t.alpha])},MoveWindow.prototype.open=function(t,e){var i=this.element.style;t<0&&(t=0),e<0&&(e=0),void 0!=t&&(i.left=t+"px"),void 0!=e&&(i.top=e+"px"),i.display="block";var r=this.element.offsetWidth,o=this.element.offsetHeight;t+r>window.innerWidth-20&&(i.left=window.innerWidth-r-20+"px"),e+o>window.innerHeight-20&&(i.top=window.innerHeight-o-20+"px")},MoveWindow.prototype.close=function(){this.element.style.display="none"},MoveWindow.prototype.move=function(t,e){if(e.isdown&&!(e.button>0)){var i=e.element.style;i.left=parseInt(i.left)+e.deltaX+"px",i.top=parseInt(i.top)+e.deltaY+"px"}},MoveWindow.prototype.down=function(t,e){return!1},ColourPicker.prototype=new MoveWindow,ColourPicker.prototype.constructor=MoveWindow,ColourPicker.prototype.pick=function(t,e,i){this.update(t.HSVA()),"block"!=this.element.style.display&&MoveWindow.prototype.open.call(this,e,i)},ColourPicker.prototype.select=function(t,e,i){if(!e||!i){var r=findElementPos(t);e=e?e:r[0]+32,i=i?i:r[1]+32}var o=new Colour(t.style.backgroundColor);this.update(o.HSVA()),"block"!=this.element.style.display&&(MoveWindow.prototype.open.call(this,e,i),this.target=t)},ColourPicker.prototype.click=function(t,e){if("pickCLOSE"==e.target.id)this.abortfn&&this.abortfn(),toggle("picker");else if("pickOK"==e.target.id){if(this.savefn&&this.savefn(this.picked),this.target){var i=new Colour(this.picked);this.target.style.backgroundColor=i.html()}toggle("picker")}else"SV"==e.target.id?this.setSV(e):"Hslide"==e.target.id||"hue"==e.target.className?this.setHue(e):"Oslide"!=e.target.id&&"opacity"!=e.target.className||this.setOpacity(e)},ColourPicker.prototype.move=function(t,e){e.isdown&&0==e.button&&("picker"==e.target.id||"pickCUR"==e.target.id||"pickRGB"==e.target.id?MoveWindow.prototype.move.call(this,t,e):e.target&&this.click(t,e))},ColourPicker.prototype.wheel=function(t,e){this.incHue(-t.spin)},ColourPicker.prototype.setSV=function(t){var e=t.clientx-parseInt($("SV").offsetLeft),i=t.clienty-parseInt($("SV").offsetTop);this.picked.S=scale(e,this.size,0,this.max.S),this.picked.V=this.max.V-scale(i,this.size,0,this.max.V),this.update(this.picked)},ColourPicker.prototype.setHue=function(t){var e=(t.clientx-parseInt($("H").offsetLeft),t.clienty-parseInt($("H").offsetTop));this.picked.H=scale(e,this.size,0,this.max.H),this.update(this.picked)},ColourPicker.prototype.incHue=function(t){this.picked.H+=t,this.picked.H=clamp(this.picked.H,0,this.max.H),this.update(this.picked)},ColourPicker.prototype.setOpacity=function(t){var e=(t.clientx-parseInt($("O").offsetLeft),t.clienty-parseInt($("O").offsetTop));this.picked.A=1-clamp(e/this.size,0,1),this.update(this.picked)},ColourPicker.prototype.updateString=function(t){t||(t=prompt("Edit colour:",this.colour.html())),t&&(this.colour=new Colour(t),this.update(this.colour.HSV()))},ColourPicker.prototype.update=function(t){this.picked=t,this.colour=new Colour(t),rgba=this.colour.rgbaObj(),rgbaStr=this.colour.html(),bgcol=new Colour({H:t.H,S:100,V:100,A:255}),$("pickRGB").innerHTML=this.colour.printString(),$S("pickCUR").background=rgbaStr,$S("pickCUR").backgroundColour=rgbaStr,$S("SV").backgroundColor=bgcol.htmlHex(),$S("Hslide").top=this.size*(t.H/360)-this.oh+"px",$S("SVslide").top=Math.round(this.size-this.size*(t.V/100)-this.sv)+"px",$S("SVslide").left=Math.round(this.size*(t.S/100)-this.sv)+"px",$S("Oslide").top=this.size*(1-t.A)-this.oh-1+"px"},GradientEditor.prototype.read=function(t){this.palette=new Palette(t,this.premultiply),this.reset(),this.update(!0)},GradientEditor.prototype.update=function(t){this.changed=!0,this.palette.draw(this.canvas,!0),!t&&this.callback&&this.callback(this)},GradientEditor.prototype.get=function(t,e){return!(e&&!this.changed)&&(this.changed=!1,this.palette.draw(t,!1),!0)},GradientEditor.prototype.insert=function(t,e,i){this.inserting=!0;var r=new Colour;this.editing=this.palette.newColour(t,r),this.update(),this.picker.pick(r,e,i)},GradientEditor.prototype.editBackground=function(t){this.editing=-1;var e=findElementPos(t);this.element=t,this.picker.pick(this.palette.background,e[0]+32,e[1]+32)},GradientEditor.prototype.edit=function(t,e,i){if("number"==typeof t)this.editing=t,this.picker.pick(this.palette.colours[t].colour,e,i);else if("object"==typeof t){this.cancel(),this.element=t;var r=new Colour(t.style.backgroundColor),o=findElementPos(t);this.picker.pick(r,o[0]+32,o[1]+32)}this.update()},GradientEditor.prototype.save=function(t){if(null!=this.editing&&(this.editing>=0?this.palette.colours[this.editing].colour.setHSV(t):this.palette.background.setHSV(t)),this.element){var e=new Colour(0);e.setHSV(t),this.element.style.backgroundColor=e.html(),this.element.onchange&&this.element.onchange()}this.reset(),this.update()},GradientEditor.prototype.cancel=function(){this.editing>=0&&this.inserting&&this.palette.remove(this.editing),this.reset(),this.update()},GradientEditor.prototype.reset=function(){this.inserting=!1,this.editing=null,this.element=null},GradientEditor.prototype.click=function(t,e){if(t.ctrlKey){for(var i=0;i<this.palette.colours.length;i++)this.palette.colours[i].position=1-this.palette.colours[i].position;return this.update(),!1}if(this.scrollable||(e.x=e.clientx),null!=e.slider)return e.slider=null,this.palette.sort(),this.update(),!1;var r=this.canvas;if(r.getContext){this.cancel();var o=(r.getContext("2d"),findElementPos(r)[1]+30),i=this.palette.inRange(e.x,this.palette.slider.width,r.width);i>=0?0==t.button?this.edit(i,t.clientX-128,o):2==t.button&&(this.palette.remove(i),this.update()):this.insert(e.x/r.width,t.clientX-128,o)}return!1},GradientEditor.prototype.down=function(t,e){return!1},GradientEditor.prototype.move=function(t,e){if(!e.isdown)return!0;if(this.scrollable||(e.x=e.clientx),null==e.slider){var i=this.palette.inDragRange(e.x,this.palette.slider.width,this.canvas.width);i>0&&(e.slider=i)}null==e.slider?e.isdown=!1:(e.x<1&&(e.x=1),e.x>this.canvas.width-1&&(e.x=this.canvas.width-1),this.palette.colours[e.slider].position=e.x/this.canvas.width,this.update(!0))},GradientEditor.prototype.wheel=function(t,e){this.timer?clearTimeout(this.timer):this.canvas.style.cursor="wait",this.spin+=.01*t.spin;var i=this;this.timer=setTimeout(function(){i.cycle(i.spin),i.spin=0},150)},GradientEditor.prototype.leave=function(t,e){},GradientEditor.prototype.cycle=function(t){this.canvas.style.cursor="default",this.timer=null;for(var e=1;e<this.palette.colours.length-1;e++){var i=this.palette.colours[e].position;i+=t,i<=0&&(i+=1),i>=1&&(i-=1),this.palette.colours[e].position=i}this.palette.sort(),this.update()},Slicer.prototype.toggle=function(){"hidden"==this.container.style.visibility?this.container.style.visibility="visible":this.container.style.visibility="hidden"},Slicer.prototype.addGUI=function(t){this.gui=t;var e=this,i=this.gui.addFolder("Slices");i.add(this.properties,"show").onFinishChange(function(t){e.toggle()}),i.add(this.properties,"layout").onFinishChange(function(t){e.doLayout(),e.draw()}),i.add(this.properties,"zoom",.01,4,.1).onFinishChange(function(t){e.doLayout(),e.draw()}),i.add(this.properties,"brightness",-1,1,.01),i.add(this.properties,"contrast",0,3,.01),i.add(this.properties,"power",.01,5,.01),i.add(this.properties,"usecolourmap"),i.open();var r=function(t){e.draw()};for(var o in i.__controllers)i.__controllers[o].onChange(r)},Slicer.prototype.get=function(){var t={};return t.properties=this.properties,t},Slicer.prototype.load=function(t){for(var e in t.properties)this.properties[e]=t.properties[e]},Slicer.prototype.setX=function(t){this.properties.X=t*this.res[0],this.draw()},Slicer.prototype.setY=function(t){this.properties.Y=t*this.res[1],this.draw()},Slicer.prototype.setZ=function(t){this.properties.Z=t*this.res[2],this.draw()},Slicer.prototype.doLayout=function(){this.viewers=[];var t=0,e=0,i=0,r=0,o=!0;removeChildren(this.container);var n=this,s="",a=0,l=function(o){var l=1;s&&(l=parseFloat(s));var h=new SliceView(n,t,e,o,r,l);n.viewers.push(h),n.container.appendChild(h.div),e+=h.viewport.height+5;var u=h.viewport.width+5;u>a&&(a=u),e>i&&(i=e)};this.flipY=!1;for(var h=0;h<this.properties.layout.length;h++){var u=this.properties.layout.charAt(h);switch(r=0,u){case"X":r=90;case"x":l(0);break;case"Y":r=90;case"y":l(1);break;case"Z":r=90;case"z":l(2);break;case"|":e=0,t+=a,a=0;break;case"_":this.flipY=!0;break;case"-":o=!1;break;default:s+=u;continue}s=""}this.width=t+a,this.height=i,this.container.appendChild(this.canvas),o?(this.container.style.bottom="",this.container.style.top=this.height+10+"px"):(this.container.style.top=void 0,this.container.style.bottom="10px")},Slicer.prototype.loadImage=function(t){for(var e=0;e<3;e++)this.webgl.loadTexture(t,this.filter);this.reset()},Slicer.prototype.reset=function(){this.dimx=this.image.width/this.res[0],this.dimy=this.image.height/this.res[1]},Slicer.prototype.updateColourmap=function(){this.webgl.updateTexture(this.webgl.gradientTexture,$("gradient"),this.gl.TEXTURE2),this.draw()},Slicer.prototype.draw=function(){this.slices=[(this.properties.X-1)/(this.res[0]-1),(this.properties.Y-1)/(this.res[1]-1),(this.properties.Z-1)/(this.res[2]-1)],this.width==this.canvas.width&&this.height==this.canvas.height||(this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this.webgl&&(this.gl.viewportWidth=this.width,this.gl.viewportHeight=this.height,this.webgl.viewport=new Viewport(0,0,this.width,this.height))),this.webgl.use(this.program),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.webgl.gradientTexture),this.gl.uniform1i(this.program.uniforms.palette,0),this.gl.uniform1i(this.program.uniforms.colourmap,this.properties.usecolourmap),this.gl.uniform1f(this.program.uniforms.bright,this.properties.brightness),this.gl.uniform1f(this.program.uniforms.cont,this.properties.contrast),this.gl.uniform1f(this.program.uniforms.power,this.properties.power),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.webgl.textures[0]),this.gl.uniform1i(this.program.uniforms.texture,1),this.gl.scissor(0,0,this.width,this.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);for(var t=0;t<this.viewers.length;t++)this.drawSlice(t)},Slicer.prototype.drawSlice=function(t){var e,i=this.viewers[t],r=i.viewport;e=90==i.rotate?[1-this.slices[i.j],this.slices[i.i]]:[this.slices[i.i],this.slices[i.j]],this.flipY||(e[1]=1-e[1]),this.webgl.viewport=r,this.gl.scissor(r.x,r.y,r.width,r.height),this.webgl.modelView.identity(),this.webgl.modelView.translate([.5,.5,0]),this.webgl.modelView.rotate(-i.rotate,[0,0,1]);var o=[.5,-.5,-1];this.flipY&&(o[1]=-o[1]),this.webgl.modelView.scale(o),this.gl.uniform3f(this.program.uniforms.slice,this.slices[0],this.slices[1],this.slices[2]),this.gl.uniform2f(this.program.uniforms.dim,this.dimx,this.dimy),this.gl.uniform3i(this.program.uniforms.res,this.res[0],this.res[1],this.res[2]),this.gl.uniform1i(this.program.uniforms.axis,i.axis),this.gl.uniform2i(this.program.uniforms.select,r.width*e[0]+r.x,r.height*e[1]+r.y),this.webgl.initDraw2d(),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.webgl.vertexPositionBuffer.numItems)},SliceView.prototype.click=function(t,e){this.slicer.flipY&&(e.y=e.element.clientHeight-e.y);var i;i=90==this.rotate?[e.y/e.element.clientHeight,1-e.x/e.element.clientWidth]:[e.x/e.element.clientWidth,e.y/e.element.clientHeight];var r=Math.round(this.slicer.res[this.i]*i[0]),o=Math.round(this.slicer.res[this.j]*i[1]);0==this.axis?(slicer.properties.Z=r,slicer.properties.Y=o):1==this.axis?(slicer.properties.X=r,slicer.properties.Z=o):(slicer.properties.X=r,slicer.properties.Y=o),this.slicer.draw()},SliceView.prototype.wheel=function(t,e){0==this.axis&&(slicer.properties.X+=t.spin),1==this.axis&&(slicer.properties.Y+=t.spin),2==this.axis&&(slicer.properties.Z+=t.spin),this.slicer.draw()},SliceView.prototype.move=function(t,e){e.isdown&&this.click(t,e)},Volume.prototype.box=function(t,e){var i=new Float32Array([t[0],t[1],e[2],t[0],e[1],e[2],e[0],e[1],e[2],e[0],t[1],e[2],t[0],t[1],t[2],t[0],e[1],t[2],e[0],e[1],t[2],e[0],t[1],t[2]]),r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,3,7,1,5,2,6]);this.boxPositionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.boxPositionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.boxPositionBuffer.itemSize=3,this.boxIndexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.boxIndexBuffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,r,this.gl.STATIC_DRAW),this.boxIndexBuffer.numItems=24},Volume.prototype.addGUI=function(t){this.gui&&this.gui.destroy(),this.gui=t;var e=this.gui.addFolder("Volume");e.add(this.properties,"interactive"),e.add(this.properties,"usecolourmap"),this.properties.samples=Math.floor(this.properties.samples),this.properties.samples%32>0&&(this.properties.samples-=this.properties.samples%32),e.add(this.properties,"samples",32,1024,32),e.add(this.properties,"density",0,50,1),e.add(this.properties,"brightness",-1,1,.05),e.add(this.properties,"contrast",0,2,.05),e.add(this.properties,"saturation",0,2,.05),e.add(this.properties,"power",.01,5,.05),e.add(this.properties,"mindensity",0,1,0),e.add(this.properties,"maxdensity",0,1,1),e.add(this.properties,"axes"),e.add(this.properties,"border"),e.add(this.properties,"tricubicFilter"),e.open();var i=this.gui.addFolder("Clip planes");i.add(this.properties,"xmin",0,1,.01),i.add(this.properties,"xmax",0,1,.01),i.add(this.properties,"ymin",0,1,.01),i.add(this.properties,"ymax",0,1,.01),i.add(this.properties,"zmin",0,1,.01),i.add(this.properties,"zmax",0,1,.01);var r=this.gui.addFolder("Isosurface");r.add(this.properties,"isovalue",0,1,.01),r.add(this.properties,"isowalls"),r.add(this.properties,"isoalpha",0,1,.01),r.add(this.properties,"isosmooth",.1,3,.1),r.addColor(this.properties,"colour");var o=this,n=function(t){o.delayedRender(250)};for(var s in e.__controllers)e.__controllers[s].onChange(n);for(var s in i.__controllers)i.__controllers[s].onChange(n);for(var s in r.__controllers)r.__controllers[s].onChange(n)},Volume.prototype.load=function(t){for(var e in t)this.properties[e]=t[e];void 0!=t.colourmap&&(this.properties.usecolourmap=!0),this.properties.axes=state.views[0].axes,this.properties.border=state.views[0].border,this.properties.tricubicFilter=t.tricubicfilter,state.views[0].translate&&(this.translate=state.views[0].translate),state.views[0].rotate&&(3==state.views[0].rotate.length?(this.rotateZ(-state.views[0].rotate[2]),this.rotateY(-state.views[0].rotate[1]),this.rotateX(-state.views[0].rotate[0])):0!=state.views[0].rotate[3]&&(this.rotate=quat4.create(state.views[0].rotate)))},Volume.prototype.get=function(t){var e={};return t?e.modelview=this.webgl.modelView.toArray():(e.translate=this.translate,e.rotate=[this.rotate[0],this.rotate[1],this.rotate[2],this.rotate[3]]),e.properties=this.properties,e};var frames=0,testtime;Volume.prototype.draw=function(t,e){if(this.properties&&this.webgl){if(0!=this.width&&0!=this.height||(this.width=window.innerWidth,this.height=window.innerHeight),this.width==this.canvas.width&&this.height==this.canvas.height||(this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this.gl&&(this.gl.viewportWidth=this.width,this.gl.viewportHeight=this.height,this.webgl.viewport=new Viewport(0,0,this.width,this.height))),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.viewport(this.webgl.viewport.x,this.webgl.viewport.y,this.webgl.viewport.width,this.webgl.viewport.height),this.properties.border&&this.drawBox(1),this.properties.axes&&this.drawAxis(1),!t||this.properties.interactive){this.webgl.modelView.push(),this.rayCamera(),this.webgl.use(this.program),this.gl.disableVertexAttribArray(this.program.attributes.aVertexColour),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.webgl.textures[0]),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.webgl.gradientTexture),this.gl.uniform1i(this.program.uniforms.uSamples,t?.5*this.properties.samples:this.properties.samples),this.gl.uniform1i(this.program.uniforms.uVolume,0),this.gl.uniform1i(this.program.uniforms.uTransferFunction,1),this.gl.uniform1i(this.program.uniforms.uEnableColour,this.properties.usecolourmap),this.gl.uniform1i(this.program.uniforms.uFilter,!t&&this.properties.tricubicFilter),this.gl.uniform4fv(this.program.uniforms.uViewport,new Float32Array([0,0,this.gl.viewportWidth,this.gl.viewportHeight]));var i=[this.properties.xmin,this.properties.ymin,this.properties.zmin],r=[this.properties.xmax,this.properties.ymax,this.properties.zmax];this.gl.uniform3fv(this.program.uniforms.uBBMin,new Float32Array(i)),this.gl.uniform3fv(this.program.uniforms.uBBMax,new Float32Array(r)),
this.gl.uniform3fv(this.program.uniforms.uResolution,new Float32Array(this.resolution)),this.gl.uniform1f(this.program.uniforms.uDensityFactor,this.properties.density),this.gl.uniform1f(this.program.uniforms.uSaturation,this.properties.saturation),this.gl.uniform1f(this.program.uniforms.uBrightness,this.properties.brightness),this.gl.uniform1f(this.program.uniforms.uContrast,this.properties.contrast),this.gl.uniform1f(this.program.uniforms.uPower,this.properties.power),this.gl.uniform1f(this.program.uniforms.uIsoValue,this.properties.isovalue);var o=new Colour(this.properties.colour);o.alpha=this.properties.isoalpha,this.gl.uniform4fv(this.program.uniforms.uIsoColour,o.rgbaGL()),this.gl.uniform1f(this.program.uniforms.uIsoSmooth,this.properties.isosmooth),this.gl.uniform1i(this.program.uniforms.uIsoWalls,this.properties.isowalls),this.gl.uniform2fv(this.program.uniforms.uRange,new Float32Array([0,1])),this.gl.uniform2fv(this.program.uniforms.uDenMinMax,new Float32Array([this.properties.mindensity,this.properties.maxdensity])),this.webgl.initDraw2d(),this.gl.uniformMatrix4fv(this.program.uniforms.uInvPMatrix,!1,this.invPMatrix),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.webgl.vertexPositionBuffer.numItems),this.webgl.modelView.pop()}else this.properties.axes||this.drawAxis(1),this.drawBox(1);if(this.gl.clear(this.gl.DEPTH_BUFFER_BIT),this.properties.axes&&this.drawAxis(.2),this.properties.border&&this.drawBox(.2),e)if(frames++,$("status").innerHTML="Speed test: frame "+frames,5==frames){var n=(new Date).getTime()-testtime;console.log("5 frames in "+n/1e3+" seconds"),n>1e3?(this.properties.samples=Math.floor(1e3*this.properties.samples/n),this.properties.samples<32&&(this.properties.samples=32),$("status").innerHTML="5 frames in "+n/1e3+" seconds, Reduced quality to "+this.properties.samples,setTimeout(function(){info.hide()},2e3)):info.hide()}else this.draw(!0,!0)}},Volume.prototype.camera=function(){this.webgl.modelView.identity(),this.webgl.modelView.translate(this.translate),adjust=[-(this.focus[0]-this.centre[0]),-(this.focus[1]-this.centre[1]),-(this.focus[2]-this.centre[2])],this.webgl.modelView.translate(adjust);var t=quat4.toMat4(this.rotate);this.webgl.modelView.mult(t),adjust=[this.focus[0]-this.centre[0],this.focus[1]-this.centre[1],this.focus[2]-this.centre[2]],this.webgl.modelView.translate(adjust),this.webgl.modelView.translate([-this.focus[0],-this.focus[1],-this.focus[2]*this.orientation]),this.webgl.setPerspective(this.fov,this.gl.viewportWidth/this.gl.viewportHeight,.1,100)},Volume.prototype.rayCamera=function(){this.webgl.modelView.identity(),this.webgl.modelView.translate(this.translate);var t=quat4.toMat4(this.rotate);this.webgl.modelView.mult(t),this.webgl.modelView.translate([.5*-this.scaling[0],.5*-this.scaling[1],.5*-this.scaling[2]]),this.webgl.modelView.scale([this.iscale[0],this.iscale[1],this.iscale[2]]),this.webgl.setPerspective(this.fov,this.gl.viewportWidth/this.gl.viewportHeight,.1,100),this.invPMatrix=mat4.create(this.webgl.perspective.matrix),mat4.inverse(this.invPMatrix)},Volume.prototype.drawAxis=function(t){this.camera(),this.webgl.use(this.lineprogram),this.gl.uniform1f(this.lineprogram.uniforms.uAlpha,t),this.gl.uniform4fv(this.lineprogram.uniforms.uColour,new Float32Array([1,1,1,0])),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.linePositionBuffer),this.gl.enableVertexAttribArray(this.lineprogram.attributes.aVertexPosition),this.gl.vertexAttribPointer(this.lineprogram.attributes.aVertexPosition,this.linePositionBuffer.itemSize,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.lineColourBuffer),this.gl.enableVertexAttribArray(this.lineprogram.attributes.aVertexColour),this.gl.vertexAttribPointer(this.lineprogram.attributes.aVertexColour,this.lineColourBuffer.itemSize,this.gl.FLOAT,!1,0,0);var e=[.5*this.scaling[0],.5*this.scaling[1],.5*this.scaling[2]];this.slicer&&(e=[this.slicer.slices[0]*this.scaling[0],this.slicer.slices[1]*this.scaling[1],this.slicer.slices[2]*this.scaling[2]]),this.webgl.modelView.translate(e),this.webgl.setMatrices(),this.gl.drawArrays(this.gl.LINES,0,this.linePositionBuffer.numItems),this.webgl.modelView.translate([-e[0],-e[1],-e[2]])},Volume.prototype.drawBox=function(t){this.camera(),this.webgl.use(this.lineprogram),this.gl.uniform1f(this.lineprogram.uniforms.uAlpha,t),this.gl.uniform4fv(this.lineprogram.uniforms.uColour,this.borderColour.rgbaGL()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.boxPositionBuffer),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.boxIndexBuffer),this.gl.enableVertexAttribArray(this.lineprogram.attributes.aVertexPosition),this.gl.vertexAttribPointer(this.lineprogram.attributes.aVertexPosition,this.boxPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0),this.gl.vertexAttribPointer(this.lineprogram.attributes.aVertexColour,4,this.gl.UNSIGNED_BYTE,!0,0,0),this.webgl.modelView.scale(this.scaling),this.webgl.setMatrices(),this.gl.drawElements(this.gl.LINES,this.boxIndexBuffer.numItems,this.gl.UNSIGNED_SHORT,0)},Volume.prototype.timeAction=function(t,e){function i(){var e=(new Date).getTime()-r;e<50?window.requestAnimationFrame(i):console.log(t+" took: "+e/1e3+" seconds")}if(window.requestAnimationFrame){var r=e||(new Date).getTime();window.requestAnimationFrame(i)}},Volume.prototype.rotateX=function(t){this.rotation(t,[1,0,0])},Volume.prototype.rotateY=function(t){this.rotation(t,[0,1,0])},Volume.prototype.rotateZ=function(t){this.rotation(t,[0,0,1])},Volume.prototype.rotation=function(t,e){var i=t*Math.PI/180,r=quat4.fromAngleAxis(i,e);r=quat4.normalize(r),this.rotate=quat4.multiply(r,this.rotate)},Volume.prototype.zoom=function(t){this.translate[2]+=t*this.modelsize},Volume.prototype.zoomClip=function(t){this.draw()},Volume.prototype.click=function(t,e){return this.rotating=!1,this.draw(),!1},Volume.prototype.move=function(t,e){if(this.rotating=!1,!e.isdown)return!0;var i=e.button;switch(i){case 0:this.rotateY(e.deltaX/5),this.rotateX(e.deltaY/5),this.rotating=!0;break;case 1:this.rotateZ(Math.sqrt(e.deltaX*e.deltaX+e.deltaY*e.deltaY)/5),this.rotating=!0;break;case 2:var r=this.modelsize/1e3;this.translate[0]+=e.deltaX*r,this.translate[1]-=e.deltaY*r}return this.draw(!0),!1},Volume.prototype.wheel=function(t,e){if(t.shiftKey){var i=.01*t.spin;this.zoomClip(i)}else{var i=.05*t.spin;this.zoom(i)}return this.delayedRender(250),!1},Volume.prototype.pinch=function(t,e){var i=1e-4*t.distance;console.log(" --> "+i),this.zoom(i),this.delayedRender(250)},Volume.prototype.delayedRender=function(t,e){e||this.draw(!0),this.delaytimer&&clearTimeout(this.delaytimer);var i=this;this.delaytimer=setTimeout(function(){i.draw()},t)},Volume.prototype.applyBackground=function(t){if(t){this.background=new Colour(t);var e=this.background.HSV();this.borderColour=new Colour(e.V>50?4282664004:4290493371),this.properties.usecolourmap?this.canvas.style.backgroundColor=t:this.canvas.style.backgroundColor="black"}};var volume,slicer,colours,info,colourmaps,state={},reset,filename,mobile,socket=io(),jsonfile;socket.on("savedatajson",function(t){"error"==t.status?($("status").innerHTML="Fail to save. You cannot save examples!",info.show(),setTimeout(hideMessage,3e3)):"done"==t.status&&($("status").innerHTML="Saved successfully!",info.show(),setTimeout(hideMessage,2e3))});var request,progressBar;Popup.prototype.toggle=function(){"visible"==this.style.visibility?this.hide():this.show()},Popup.prototype.show=function(){this.style.visibility="visible"},Popup.prototype.hide=function(){this.style.visibility="hidden"};