<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Monash MIVP Cave2 Volume Renderer</title>

    <!-- Bootstrap style-->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/css/bootstrap-dialog.min.css" />

    <!-- style -->
    <link rel="stylesheet" href="css/style.css">

</head>

<body>
    <div id="header"></div>

    <div class="container">
        <h3 class="section-heading">Upload Data</h3>
        <p> Formats Supported: </p>
        <ul>
            <li> TIFF Image Stack (.zip file of an indexed TIFF image stack). Example data <a href="data/example/tiffstack-foot.zip">tiffstack-foot.zip</a> </li>
        </ul>
        
        <button type="button" id="btnUploadFile">Upload File</button>
        <input id="upload-input" type="file" name="uploads"></br>
        <label id="upload_filename">File selected: </label></br>
        <div class="progress" style="width: 300px">
            <div class="progress-bar" role="progressbar"></div>
        </div>
            
        <div id="local_upload_message">
            <img id="process_img" src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH+GkNyZWF0ZWQgd2l0aCBhamF4bG9hZC5pbmZvACH5BAAKAAAAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQACgABACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkEAAoAAgAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkEAAoAAwAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkEAAoABAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQACgAFACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQACgAGACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAAKAAcALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA=="/>
            <label id="message_label">Uploading... please wait!</label>
        </div>
        <div id="local_upload_result_container">
        </div>
    </div>    

	<div id="footer"></div>
	
	<!-- SCRIPT -->
	<!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!-- Bootstrap-->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/js/bootstrap-dialog.min.js"></script>
    <!-- socket.io -->
    <script src="https://cdn.socket.io/socket.io-1.4.3.js"></script>
    
    <script>
        var socket = io();
        
        $('#header').load("header.html");
   		$('#footer').load("footer.html");
   		
        $('#btnUploadFile').on('click', function (){
            $('#upload-input').click();
            $('.progress-bar').text('0%');
            $('.progress-bar').width('0%');
        });
        
        $('#upload-input').on('change', function(){
            var files = $(this).get(0).files;
            
            if (files.length > 0){
                file = files[0];
                console.log(file);
                document.getElementById("upload_filename").innerHTML = "File selected: " + file.name;
                var formData = new FormData();
                formData.append('uploads', file, file.name);
                console.log(formData);
                
                $.ajax({
                    url: '/localupload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data){
                        console.log(data);
                        if(data.status == 'error') {
                            BootstrapDialog.show({
                                title: 'Fail to upload file',
                                message: data.detail,
                                type: BootstrapDialog.TYPE_DANGER
                            });
                            return;
                        }
                        document.getElementById("local_upload_message").style.display = "block";
                        lmessage = document.getElementById("message_label");
                        lmessage.style.color = 'blue';
                        lmessage.innerHTML = "Uploaded successfully! Now working... ";
                        process_img = document.getElementById("process_img");
                        process_img.style.visibility = 'visible';  
                        socket.emit('processuploadfile', {task: "process", file: data.file});
                    },
                    xhr: function() {
                        // create an XMLHttpRequest
                        var xhr = new XMLHttpRequest();
                        
                        // listen to the 'progress' event
                        xhr.upload.addEventListener('progress', function(evt) {
                        
                        if (evt.lengthComputable) {
                            // calculate the percentage of upload completed
                            var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);
                            
                            // update the Bootstrap progress bar with the new percentage
                            $('.progress-bar').text(percentComplete + '%');
                            $('.progress-bar').width(percentComplete + '%');
                            
                            // once the upload reaches 100%, set the progress bar text to done
                            if (percentComplete === 100) {
                                $('.progress-bar').html('Done');
                            }
                        }
                    
                    }, false);
                    
                    return xhr;
                    }
                });
            }
        });

        socket.on('processuploadfile', function (data) {
            var lmessage = document.getElementById("message_label");
            var process_img = document.getElementById("process_img");
            console.log(data);
            if(data.status === 'working') {   
                process_img.style.visibility = 'visible';                      
                lmessage.style.color = 'blue';
                lmessage.innerHTML = "Working... " + data.result;
            }
            else if (data.status === 'done') {
                process_img.style.visibility = 'hidden';
                lmessage.style.color = 'blue';
                lmessage.innerHTML = '';
                $("#local_upload_message").hide();
                
                var local_upload_result_container = document.getElementById("local_upload_result_container");
                local_upload_result_container.innerHTML = "";
                
                var img_div = document.createElement("div");
                var img_a = document.createElement("a");
                img_a.href = data.png; img_a.target = "_blank";
                var img = document.createElement("img");
                img.setAttribute("class", "result_img");
                img.src = data.thumb;
                img_a.appendChild(img);
                img_div.appendChild(img_a);
                local_upload_result_container.appendChild(img_div);
            
                var tag_label = document.createElement("label");
                tag_label.setAttribute("class", "result_label");
                tag_label.innerHTML = '<h4>Tag: <b><font color="red">' + data.tag + '</font></b> Please write down for later use</h4>';
                local_upload_result_container.appendChild(tag_label);
                
                var view_button = document.createElement("button");
                view_button.setAttribute("class", "view_button");
                view_button.setAttribute("id", data.json);
                view_button.innerHTML = 'View';
                view_button.onclick = function () {
                    window.open('sharevol/index.html?data=' + $(this).prop('id') + '&reset', target="_blank");
                };
                local_upload_result_container.appendChild(view_button);
                
            }
            else if (data.status === 'error') {
                lmessage.style.color = 'red';
                lmessage.innerHTML = "Error: " + data.result;
                process_img.style.visibility = 'hidden';
                BootstrapDialog.show({
                    title: 'Error',
                    message: data.detail,
                    type: BootstrapDialog.TYPE_DANGER
                });
            }
        });
        
    </script>
</body>
